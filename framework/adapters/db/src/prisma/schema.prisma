generator kysely {
  provider        = "prisma-kysely"
  output          = "../generated/kysely"
  previewFeatures = ["partialIndexes"]
}

datasource db {
  provider = "postgresql"
  schemas  = ["core", "ent", "meta", "public", "ref", "ui"]
}

model Tenant {
  id                              String                            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                            String                            @unique
  name                            String
  display_name                    String
  realm_key                       String                            @default("main")
  status                          String                            @default("active")
  region                          String?
  subscription                    String                            @default("base")
  createdAt                       DateTime                          @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy                       String                            @map("created_by")
  updatedAt                       DateTime?                         @map("updated_at") @db.Timestamptz(6)
  updatedBy                       String?                           @map("updated_by")
  address                         address[]
  address_link                    address_link[]
  approval_comment                approval_comment[]
  approval_definition             approval_definition[]
  approval_instance               approval_instance[]
  approval_task                   approval_task[]
  attachment                      attachment[]
  audit_dlq                       audit_dlq[]
  audit_hash_anchor               audit_hash_anchor[]
  audit_log                       audit_log[]
  comment_analytics_daily         comment_analytics_daily[]
  comment_draft                   comment_draft[]
  comment_flag                    comment_flag[]
  comment_mention                 comment_mention[]
  comment_moderation_status       comment_moderation_status[]
  comment_reaction                comment_reaction[]
  comment_read_status             comment_read_status[]
  comment_response_history        comment_response_history[]
  comment_retention_log           comment_retention_log[]
  comment_retention_policy        comment_retention_policy[]
  comment_sla_config              comment_sla_config[]
  comment_sla_metrics             comment_sla_metrics[]
  comment_thread_analytics        comment_thread_analytics[]
  comment_user_engagement         comment_user_engagement[]
  contact_phone                   contact_phone[]
  contact_point                   contact_point[]
  doc_brand_profile               doc_brand_profile[]
  doc_letterhead                  doc_letterhead[]
  doc_output                      doc_output[]
  doc_render_dlq                  doc_render_dlq[]
  doc_render_job                  doc_render_job[]
  doc_template                    doc_template[]
  doc_template_binding            doc_template_binding[]
  doc_template_version            doc_template_version[]
  document                        document[]
  email_otp_instance              email_otp_instance[]
  entitlement                     entitlement[]
  entity_comment                  entity_comment[]
  entity_tag                      entity_tag[]
  feature_flag                    feature_flag[]
  field_access_log                field_access_log[]
  groupMembers                    GroupMember[]
  idpIdentities                   IdpIdentity[]
  job                             job[]
  job_run                         job_run[]
  lifecycle                       core_lifecycle[]
  lifecycle_timer_schedule        lifecycle_timer_schedule[]
  lifecycle_version               lifecycle_version[]
  mfa_challenge                   mfa_challenge[]
  mfa_config                      mfa_config[]
  notification_digest_staging     notification_digest_staging[]
  notification_dlq                notification_dlq[]
  core_notification_preference    core_notification_preference[]
  organizational_unit             organizational_unit[]
  outbox                          outbox[]
  password_history                password_history[]
  permission_decision_log         PermissionDecisionLog[]
  principals                      Principal[]
  principal_group                 principal_group[]
  principal_locale_override       principal_locale_override[]
  principal_ou                    principal_ou[]
  principalProfiles               PrincipalProfile[]
  principal_role                  principal_role[]
  principal_workspace_access      principal_workspace_access[]
  roles                           Role[]
  security_event                  security_event[]
  sms_otp_instance                sms_otp_instance[]
  system_config                   system_config[]
  tenant_locale_policy            tenant_locale_policy[]
  tenant_module_subscription      tenant_module_subscription[]
  tenantProfile                   TenantProfile?
  totp_instance                   totp_instance[]
  trusted_device                  trusted_device[]
  webauthn_credential             webauthn_credential[]
  whatsapp_consent                whatsapp_consent[]
  workflow_audit_event            workflow_audit_event[]
  workflow_instance               workflow_instance[]
  workflow_transition             workflow_transition[]
  workspace_feature               workspace_feature[]
  workspace_usage_metric          workspace_usage_metric[]
  customer                        customer[]
  employee                        employee[]
  entity_relationship             entity_relationship[]
  product                         product[]
  product_category                product_category[]
  supplier                        supplier[]
  approval_sla_policy             approval_sla_policy[]
  approval_template               approval_template[]
  approval_template_rule          approval_template_rule[]
  approval_template_stage         approval_template_stage[]
  audit_policy                    audit_policy[]
  entity                          entity[]
  entity_compiled                 entity_compiled[]
  entity_compiled_overlay         entity_compiled_overlay[]
  entity_lifecycle                entity_lifecycle[]
  entity_lifecycle_route_compiled entity_lifecycle_route_compiled[]
  entity_policy                   entity_policy[]
  entity_version                  entity_version[]
  field                           field[]
  field_security_policy           field_security_policy[]
  index_def                       index_def[]
  meta_lifecycle                  meta_lifecycle[]
  lifecycle_state                 lifecycle_state[]
  lifecycle_timer_policy          lifecycle_timer_policy[]
  lifecycle_transition            lifecycle_transition[]
  lifecycle_transition_gate       lifecycle_transition_gate[]
  overlay                         overlay[]
  overlay_change                  overlay_change[]
  permission_policy               PermissionPolicy[]
  permission_policy_compiled      PermissionPolicyCompiled[]
  permission_policy_version       PermissionPolicyVersion[]
  permission_rule                 PermissionRule[]
  permission_rule_operation       PermissionRuleOperation[]
  relation                        relation[]
  dashboard_widget                dashboard_widget[]
  notification                    notification[]
  notification_preference         notification_preference[]
  recent_activity                 recent_activity[]
  saved_view                      saved_view[]
  search_history                  search_history[]
  user_preference                 user_preference[]
  entity_document_link            entity_document_link[]
  document_acl                    document_acl[]
  attachment_access_log           attachment_access_log[]
  attachment_comment              attachment_comment[]
  multipart_upload                multipart_upload[]

  @@index([realm_key], map: "idx_tenant_realm_key")
  @@index([status], map: "idx_tenant_status_active", where: raw("(status = 'active'::text)"))
  @@map("tenant")
  @@schema("core")
}

/// B1: Principal - Canonical athyper actor (user/service/external)
model Principal {
  id                                                                   String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId                                                             String                       @map("tenant_id") @db.Uuid
  realm_key                                                            String                       @default("main")
  principalType                                                        String                       @map("principal_type")
  principal_code                                                       String                       @unique
  displayName                                                          String?                      @map("display_name")
  email                                                                String?
  phone                                                                String?
  given_name                                                           String?
  family_name                                                          String?
  preferred_name                                                       String?
  external_id                                                          String?
  subject_id                                                           String?
  is_active                                                            Boolean                      @default(true)
  is_service_account                                                   Boolean                      @default(false)
  is_locked                                                            Boolean                      @default(false)
  password_hash                                                        String?
  password_updated_at                                                  DateTime?                    @db.Timestamptz(6)
  last_login_at                                                        DateTime?                    @db.Timestamptz(6)
  last_login_ip                                                        String?
  idp_display_name                                                     String?
  idp_family_name                                                      String?
  idp_given_name                                                       String?
  idp_email                                                            String?
  idp_email_verified                                                   Boolean?
  idp_phone_number                                                     String?
  idp_phone_verified                                                   Boolean?
  idp_picture                                                          String?
  idp_locale                                                           String?
  idp_timezone                                                         String?
  createdAt                                                            DateTime                     @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy                                                            String                       @map("created_by")
  updated_at                                                           DateTime?                    @db.Timestamptz(6)
  updated_by                                                           String?
  approval_comment                                                     approval_comment[]
  approval_instance_approval_instance_decided_byToprincipal            approval_instance[]          @relation("approval_instance_decided_byToprincipal")
  approval_instance_approval_instance_requested_byToprincipal          approval_instance[]          @relation("approval_instance_requested_byToprincipal")
  approval_task                                                        approval_task[]
  comment_draft                                                        comment_draft[]
  comment_flag_comment_flag_flagger_user_idToprincipal                 comment_flag[]               @relation("comment_flag_flagger_user_idToprincipal")
  comment_flag_comment_flag_reviewed_byToprincipal                     comment_flag[]               @relation("comment_flag_reviewed_byToprincipal")
  comment_mention                                                      comment_mention[]
  comment_moderation_status                                            comment_moderation_status[]
  comment_reaction                                                     comment_reaction[]
  comment_read_status                                                  comment_read_status[]
  comment_response_history                                             comment_response_history[]
  comment_sla_metrics_comment_sla_metrics_first_comment_byToprincipal  comment_sla_metrics[]        @relation("comment_sla_metrics_first_comment_byToprincipal")
  comment_sla_metrics_comment_sla_metrics_first_response_byToprincipal comment_sla_metrics[]        @relation("comment_sla_metrics_first_response_byToprincipal")
  comment_user_engagement                                              comment_user_engagement[]
  entitlement                                                          entitlement[]
  entity_comment                                                       entity_comment[]
  groupMemberships                                                     GroupMember[]
  idpIdentities                                                        IdpIdentity[]
  mfa_challenge                                                        mfa_challenge[]
  mfa_config                                                           mfa_config[]
  password_history                                                     password_history[]
  tenant                                                               Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal_locale_override                                            principal_locale_override?
  principal_ou                                                         principal_ou[]
  profile                                                              PrincipalProfile?
  principal_role                                                       principal_role[]
  principal_workspace_access                                           principal_workspace_access[]
  security_event                                                       security_event[]
  trusted_device                                                       trusted_device[]
  workflow_instance_workflow_instance_completed_byToprincipal          workflow_instance[]          @relation("workflow_instance_completed_byToprincipal")
  workflow_instance_workflow_instance_initiated_byToprincipal          workflow_instance[]          @relation("workflow_instance_initiated_byToprincipal")
  workflow_transition                                                  workflow_transition[]
  employee                                                             employee[]
  dashboard_widget                                                     dashboard_widget[]
  notification_notification_recipient_idToprincipal                    notification[]               @relation("notification_recipient_idToprincipal")
  notification_notification_sender_idToprincipal                       notification[]               @relation("notification_sender_idToprincipal")
  notification_preference                                              notification_preference[]
  recent_activity                                                      recent_activity[]
  saved_view                                                           saved_view[]
  search_history                                                       search_history[]
  user_preference                                                      user_preference[]

  @@unique([tenantId, external_id], map: "principal_tenant_external_uniq")
  @@index([principal_code], map: "idx_principal_code")
  @@index([tenantId, email], map: "idx_principal_email")
  @@index([tenantId, external_id], map: "idx_principal_external_id")
  @@index([tenantId, principalType], map: "idx_principal_tenant_type")
  @@index([tenantId, is_active], map: "idx_principal_active", where: raw("(is_active = true)"))
  @@map("principal")
  @@schema("core")
}

/// B1: IdP Identity - Maps external IdP (realm/provider/subject) to principal
model IdpIdentity {
  id                       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId                 String    @map("tenant_id") @db.Uuid
  principalId              String    @map("principal_id") @db.Uuid
  idp_name                 String
  idp_subject              String
  access_token             String?
  access_token_expires_at  DateTime? @db.Timestamptz(6)
  refresh_token            String?
  refresh_token_expires_at DateTime? @db.Timestamptz(6)
  id_token                 String?
  id_token_expires_at      DateTime? @db.Timestamptz(6)
  token_type               String?
  scope                    String?
  last_refreshed_at        DateTime? @db.Timestamptz(6)
  last_authenticated_at    DateTime? @db.Timestamptz(6)
  raw_claims               Json?
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy                String    @map("created_by")
  updated_at               DateTime? @db.Timestamptz(6)
  updated_by               String?
  principal                Principal @relation(fields: [principalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, idp_name, idp_subject], map: "idp_identity_tenant_idp_subject_uniq")
  @@index([tenantId, idp_name, idp_subject], map: "idx_idp_identity_idp_subject")
  @@index([tenantId, principalId], map: "idx_idp_identity_principal")
  @@map("idp_identity")
  @@schema("core")
}

/// B1: Principal Profile - Extended profile attributes
model PrincipalProfile {
  id                         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId                   String    @map("tenant_id") @db.Uuid
  principalId                String    @unique(map: "principal_profile_principal_uniq") @map("principal_id") @db.Uuid
  first_name                 String?
  last_name                  String?
  locale                     String?
  timezone                   String?
  keycloak_id                String?
  keycloak_created_at_millis BigInt?
  keycloak_federation_link   String?
  attributes                 Json?
  enabled_date               DateTime? @db.Timestamptz(6)
  disabled_date              DateTime? @db.Timestamptz(6)
  createdAt                  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy                  String    @map("created_by")
  updatedAt                  DateTime? @map("updated_at") @db.Timestamptz(6)
  updatedBy                  String?   @map("updated_by")
  principal                  Principal @relation(fields: [principalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId, keycloak_id], map: "idx_principal_profile_keycloak_id")
  @@index([tenantId], map: "idx_principal_profile_tenant")
  @@map("principal_profile")
  @@schema("core")
}

/// B2: Tenant Profile - Tenant operational defaults
model TenantProfile {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String    @unique @map("tenant_id") @db.Uuid
  country              String?
  currency             String?
  locale               String?
  timezone             String?
  fiscalYearStartMonth Int?      @map("fiscal_year_start_month")
  metadata             Json?
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy            String    @map("created_by")
  updatedAt            DateTime? @map("updated_at") @db.Timestamptz(6)
  updatedBy            String?   @map("updated_by")
  tenant               Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId], map: "idx_tenant_profile_tenant")
  @@map("tenant_profile")
  @@schema("core")
}

/// B3: Group Member - Group membership with optional validity period
model GroupMember {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String          @map("tenant_id") @db.Uuid
  groupId     String          @map("group_id") @db.Uuid
  principalId String          @map("principal_id") @db.Uuid
  joined_at   DateTime        @default(now()) @db.Timestamptz(6)
  group       principal_group @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal   Principal       @relation(fields: [principalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([groupId, principalId], map: "group_member_gp_princ_uniq")
  @@index([tenantId, principalId], map: "idx_group_member_principal")
  @@map("group_member")
  @@schema("core")
}

/// B4: Role - Role definitions with scope mode
model Role {
  id                         String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId                   String                       @map("tenant_id") @db.Uuid
  code                       String
  name                       String
  description                String?
  category                   String?
  metadata                   Json?
  createdAt                  DateTime                     @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy                  String                       @map("created_by")
  updated_at                 DateTime?                    @db.Timestamptz(6)
  updated_by                 String?
  entitlement                entitlement[]
  principal_role             principal_role[]
  principal_workspace_access principal_workspace_access[]
  tenant                     Tenant                       @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, code], map: "role_tenant_code_uniq")
  @@index([tenantId, category], map: "idx_role_category")
  @@index([tenantId], map: "idx_role_tenant")
  @@map("role")
  @@schema("core")
}

/// Permission policy container
model PermissionPolicy {
  id          String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String                    @map("tenant_id") @db.Uuid
  name        String
  description String?
  scopeType   String                    @map("scope_type")
  scopeKey    String?                   @map("scope_key")
  sourceType  String                    @default("system") @map("source_type")
  sourceRef   String?                   @map("source_ref")
  isActive    Boolean                   @default(true) @map("is_active")
  createdAt   DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy   String                    @map("created_by")
  updatedAt   DateTime?                 @map("updated_at") @db.Timestamptz(6)
  updatedBy   String?                   @map("updated_by")
  tenant      Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  versions    PermissionPolicyVersion[]

  @@unique([tenantId, name], map: "permission_policy_name_uniq")
  @@map("permission_policy")
  @@schema("meta")
}

/// Permission policy version (draft/published/archived)
model PermissionPolicyVersion {
  id               String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId         String                     @map("tenant_id") @db.Uuid
  policyId         String                     @map("permission_policy_id") @db.Uuid
  versionNo        Int                        @default(1) @map("version_no")
  status           String                     @default("draft")
  publishedAt      DateTime?                  @map("published_at") @db.Timestamptz(6)
  publishedBy      String?                    @map("published_by")
  createdAt        DateTime                   @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy        String                     @map("created_by")
  compiledPolicies PermissionPolicyCompiled[]
  policy           PermissionPolicy           @relation(fields: [policyId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant           Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rules            PermissionRule[]

  @@unique([tenantId, policyId, versionNo], map: "policy_version_uniq")
  @@map("permission_policy_version")
  @@schema("meta")
}

/// Permission rule (subject + scope + operations + conditions + effect)
model PermissionRule {
  id              String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String                    @map("tenant_id") @db.Uuid
  policyVersionId String                    @map("policy_version_id") @db.Uuid
  scopeType       String                    @map("scope_type")
  scopeKey        String?                   @map("scope_key")
  subjectType     String                    @map("subject_type")
  subjectKey      String                    @map("subject_key")
  effect          String
  conditions      Json?
  priority        Int                       @default(100)
  isActive        Boolean                   @default(true) @map("is_active")
  comment         String?
  createdAt       DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy       String                    @map("created_by")
  policyVersion   PermissionPolicyVersion   @relation(fields: [policyVersionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant          Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  operations      PermissionRuleOperation[]

  @@index([tenantId, policyVersionId, scopeType, scopeKey, subjectType, subjectKey, priority], map: "idx_permission_rule_lookup")
  @@map("permission_rule")
  @@schema("meta")
}

/// Permission rule operation mapping
model PermissionRuleOperation {
  id                   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId             String         @map("tenant_id") @db.Uuid
  ruleId               String         @map("permission_rule_id") @db.Uuid
  operationId          String         @map("operation_id") @db.Uuid
  operationConstraints Json?          @map("operation_constraints")
  createdAt            DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy            String         @map("created_by")
  operation            operation      @relation(fields: [operationId], references: [id], onUpdate: NoAction)
  rule                 PermissionRule @relation(fields: [ruleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant               Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, ruleId, operationId], map: "rule_operation_uniq")
  @@index([tenantId, operationId], map: "idx_rule_operation_op")
  @@map("permission_rule_operation")
  @@schema("meta")
}

/// Compiled policy snapshot for fast evaluation
model PermissionPolicyCompiled {
  id              String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String                  @map("tenant_id") @db.Uuid
  policyVersionId String                  @map("policy_version_id") @db.Uuid
  compiledJson    Json                    @map("compiled_json")
  compiledHash    String                  @map("compiled_hash")
  generatedAt     DateTime                @default(now()) @map("generated_at") @db.Timestamptz(6)
  createdAt       DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy       String                  @map("created_by")
  policyVersion   PermissionPolicyVersion @relation(fields: [policyVersionId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant          Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenantId, policyVersionId, compiledHash], map: "policy_compiled_hash_uniq")
  @@map("permission_policy_compiled")
  @@schema("meta")
}

/// Permission decision log (audit trail for all access decisions)
model PermissionDecisionLog {
  id                     String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId               String   @map("tenant_id") @db.Uuid
  occurredAt             DateTime @default(now()) @map("occurred_at") @db.Timestamptz(6)
  actorPrincipalId       String?  @map("actor_principal_id") @db.Uuid
  subjectSnapshot        Json?    @map("subject_snapshot")
  entityName             String?  @map("entity_name")
  entityId               String?  @map("entity_id")
  entityVersionId        String?  @map("entity_version_id") @db.Uuid
  operationCode          String   @map("operation_code")
  effect                 String
  matchedRuleId          String?  @map("matched_rule_id") @db.Uuid
  matchedPolicyVersionId String?  @map("matched_policy_version_id") @db.Uuid
  reason                 String?
  correlationId          String?  @map("correlation_id")
  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenantId, occurredAt(sort: Desc)], map: "idx_decision_log_tenant_time")
  @@index([tenantId, entityName, entityId, occurredAt(sort: Desc)], map: "idx_permission_decision_entity_timeline")
  @@index([tenantId, occurredAt(sort: Desc), effect, operationCode, actorPrincipalId, entityName, entityId, reason], map: "idx_permission_decision_timeline")
  @@map("permission_decision_log")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model address {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String         @db.Uuid
  country_code String?
  line1        String?
  line2        String?
  city         String?
  region       String?
  postal_code  String?
  metadata     Json?
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  created_by   String
  tenant       Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  address_link address_link[]

  @@unique([tenant_id, id], map: "address_tenant_id_id_uq")
  @@index([tenant_id], map: "idx_address_tenant")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model address_link {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id       String    @db.Uuid
  owner_type      String
  owner_id        String    @db.Uuid
  address_id      String    @db.Uuid
  purpose         String
  priority        Int       @default(0)
  is_primary      Boolean   @default(false)
  effective_from  DateTime  @default(now()) @db.Timestamptz(6)
  effective_until DateTime? @db.Timestamptz(6)
  metadata        Json?
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  created_by      String
  updated_at      DateTime? @db.Timestamptz(6)
  updated_by      String?
  address         address   @relation(fields: [address_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant          Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, owner_type, owner_id, purpose, address_id], map: "address_link_owner_purpose_address_uniq")
  @@index([address_id], map: "idx_address_link_address")
  @@index([tenant_id, owner_type, owner_id], map: "idx_address_link_owner")
  @@index([tenant_id, purpose], map: "idx_address_link_purpose")
  @@index([tenant_id, owner_type, owner_id], map: "idx_address_link_primary", where: raw("(is_primary = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_comment {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String            @db.Uuid
  approval_instance_id String            @db.Uuid
  approval_task_id     String?           @db.Uuid
  commenter_id         String            @db.Uuid
  comment_text         String
  created_at           DateTime          @default(now()) @db.Timestamptz(6)
  created_by           String
  visibility           String            @default("public")
  deleted_at           DateTime?         @db.Timestamptz(6)
  deleted_by           String?
  archived_at          DateTime?         @db.Timestamptz(6)
  archived_by          String?
  retention_until      DateTime?         @db.Timestamptz(6)
  retention_policy_id  String?           @db.Uuid
  approval_instance    approval_instance @relation(fields: [approval_instance_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  approval_task        approval_task?    @relation(fields: [approval_task_id], references: [id], onUpdate: NoAction)
  principal            Principal         @relation(fields: [commenter_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  tenant               Tenant            @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([commenter_id, created_at(sort: Desc)], map: "idx_approval_comment_commenter")
  @@index([approval_instance_id, created_at], map: "idx_approval_comment_instance")
  @@index([tenant_id, approval_instance_id, visibility, created_at(sort: Desc)], map: "idx_approval_comment_visibility", where: raw("(deleted_at IS NULL)"))
  @@index([tenant_id, archived_at], map: "idx_approval_comment_archived", where: raw("(archived_at IS NOT NULL)"))
  @@index([tenant_id, retention_until], map: "idx_approval_comment_retention", where: raw("((retention_until IS NOT NULL) AND (deleted_at IS NULL))"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_definition {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String              @db.Uuid
  code              String
  name              String
  description       String?
  entity_type       String
  rules             Json                @default("{\"approvers\": [], \"conditions\": []}")
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  created_by        String
  updated_at        DateTime?           @db.Timestamptz(6)
  updated_by        String?
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  approval_instance approval_instance[]

  @@unique([tenant_id, code], map: "approval_definition_tenant_code_uniq")
  @@index([tenant_id, entity_type], map: "idx_approval_definition_entity_type")
  @@index([tenant_id], map: "idx_approval_definition_tenant")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_instance {
  id                                                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                           String              @db.Uuid
  approval_definition_id                              String              @db.Uuid
  entity_type                                         String
  entity_id                                           String              @db.Uuid
  entity_version_id                                   String?             @db.Uuid
  entity_snapshot                                     Json?
  status                                              String              @default("pending")
  decision                                            String?
  requested_by                                        String              @db.Uuid
  requested_at                                        DateTime            @default(now()) @db.Timestamptz(6)
  decided_by                                          String?             @db.Uuid
  decided_at                                          DateTime?           @db.Timestamptz(6)
  reason                                              String?
  metadata                                            Json?
  created_at                                          DateTime            @default(now()) @db.Timestamptz(6)
  created_by                                          String
  updated_at                                          DateTime?           @db.Timestamptz(6)
  updated_by                                          String?
  approval_comment                                    approval_comment[]
  approval_definition                                 approval_definition @relation(fields: [approval_definition_id], references: [id], onUpdate: NoAction)
  principal_approval_instance_decided_byToprincipal   Principal?          @relation("approval_instance_decided_byToprincipal", fields: [decided_by], references: [id], onUpdate: NoAction)
  principal_approval_instance_requested_byToprincipal Principal           @relation("approval_instance_requested_byToprincipal", fields: [requested_by], references: [id], onDelete: SetNull, onUpdate: NoAction)
  tenant                                              Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  approval_task                                       approval_task[]

  @@index([tenant_id, entity_type, entity_id], map: "idx_approval_instance_entity")
  @@index([requested_by, requested_at(sort: Desc)], map: "idx_approval_instance_requested_by")
  @@index([tenant_id, status], map: "idx_approval_instance_status")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_task {
  id                   String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String             @db.Uuid
  approval_instance_id String             @db.Uuid
  approver_id          String             @db.Uuid
  order_index          Int
  status               String             @default("pending")
  assigned_at          DateTime           @default(now()) @db.Timestamptz(6)
  started_at           DateTime?          @db.Timestamptz(6)
  completed_at         DateTime?          @db.Timestamptz(6)
  decision             String?
  reason               String?
  metadata             Json?
  created_at           DateTime           @default(now()) @db.Timestamptz(6)
  created_by           String
  updated_at           DateTime?          @db.Timestamptz(6)
  updated_by           String?
  approval_comment     approval_comment[]
  approval_instance    approval_instance  @relation(fields: [approval_instance_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal            Principal          @relation(fields: [approver_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant               Tenant             @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([approver_id, status], map: "idx_approval_task_approver")
  @@index([approval_instance_id, order_index], map: "idx_approval_task_instance")
  @@index([tenant_id, status], map: "idx_approval_task_status")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model attachment {
  id                          String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                   String                     @db.Uuid
  owner_entity                String?
  owner_entity_id             String?
  file_name                   String
  content_type                String?
  size_bytes                  BigInt?
  storage_bucket              String
  storage_key                 String
  is_virus_scanned            Boolean                    @default(false)
  retention_until             DateTime?                  @db.Timestamptz(6)
  metadata                    Json?
  created_at                  DateTime                   @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime                   @default(now()) @db.Timestamptz(6)
  created_by                  String
  comment_type                String?
  comment_id                  String?                    @db.Uuid

  // Content management fields
  kind                        String                     @default("attachment")
  sha256                      String?
  original_filename           String?
  uploaded_by                 String?
  shard                       Int?
  version_no                  Int                        @default(1)
  is_current                  Boolean                    @default(true)
  parent_attachment_id        String?                    @db.Uuid
  replaced_at                 DateTime?                  @db.Timestamptz(6)
  replaced_by                 String?

  // Preview/thumbnail fields
  thumbnail_key               String?
  preview_key                 String?
  preview_generated_at        DateTime?                  @db.Timestamptz(6)
  preview_generation_failed   Boolean                    @default(false)

  // Expiration fields
  expires_at                  DateTime?                  @db.Timestamptz(6)
  auto_delete_on_expiry       Boolean                    @default(false)

  // Deduplication field
  reference_count             Int                        @default(1)

  // Relations
  tenant                      Tenant                     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  parent                      attachment?                @relation("Versions", fields: [parent_attachment_id], references: [id])
  versions                    attachment[]               @relation("Versions")
  entity_links                entity_document_link[]
  document_acls               document_acl[]
  access_logs                 attachment_access_log[]
  comments                    attachment_comment[]
  multipart_uploads           multipart_upload[]

  @@index([tenant_id, owner_entity, owner_entity_id], map: "idx_attachment_owner")
  @@index([comment_type, comment_id], map: "idx_attachment_comment", where: raw("((comment_type IS NOT NULL) AND (comment_id IS NOT NULL))"))
  @@index([tenant_id, kind, created_at(sort: Desc)])
  @@index([parent_attachment_id])
  @@index([tenant_id, sha256])
  @@index([tenant_id, owner_entity, owner_entity_id, is_current])
  @@index([tenant_id, created_at], where: raw("preview_key IS NULL AND preview_generation_failed = false AND content_type LIKE 'image/%'"), map: "idx_attachment_preview_pending")
  @@index([tenant_id, expires_at], where: raw("expires_at IS NOT NULL AND is_current = true"), map: "idx_attachment_expired")
  @@index([sha256, reference_count], where: raw("sha256 IS NOT NULL AND reference_count > 0"), map: "idx_attachment_reference_count")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model audit_log {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String   @db.Uuid
  occurred_at       DateTime @default(now()) @db.Timestamptz(6)
  actor_id          String?  @db.Uuid
  actor_type        String
  action            String
  entity_name       String?
  entity_id         String?
  entity_version_id String?  @db.Uuid
  correlation_id    String?
  ip_address        String?
  user_agent        String?
  payload           Json?
  tenant            Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, occurred_at(sort: Desc)], map: "idx_audit_log_tenant_time")
  @@index([tenant_id, entity_name, entity_id, occurred_at(sort: Desc)], map: "idx_audit_log_entity_timeline")
  @@index([tenant_id, occurred_at(sort: Desc), action, entity_name, entity_id, actor_id, payload], map: "idx_audit_log_timeline")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model contact_phone {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String        @db.Uuid
  contact_point_id String        @db.Uuid
  e164             String?
  country_code     String?
  national_number  String?
  carrier_hint     String?
  created_at       DateTime      @default(now()) @db.Timestamptz(6)
  created_by       String
  contact_point    contact_point @relation(fields: [contact_point_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant           Tenant        @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model contact_point {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String          @db.Uuid
  owner_type    String
  owner_id      String          @db.Uuid
  channel_type  String
  value         String
  purpose       String?
  is_primary    Boolean         @default(false)
  is_verified   Boolean         @default(false)
  metadata      Json?
  created_at    DateTime        @default(now()) @db.Timestamptz(6)
  created_by    String
  contact_phone contact_phone[]
  tenant        Tenant          @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, owner_type, owner_id], map: "idx_contact_point_owner")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model document {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String    @db.Uuid
  code       String?
  title      String?
  tags       String[]
  metadata   Json?
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  created_by String
  updated_at DateTime? @db.Timestamptz(6)
  updated_by String?
  tenant     Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tags], map: "idx_document_tags", type: Gin)
  @@index([tenant_id, code], map: "idx_document_tenant_code")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model email_otp_instance {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String     @db.Uuid
  mfa_config_id String     @db.Uuid
  email_address String
  verified_at   DateTime?  @db.Timestamptz(6)
  created_at    DateTime   @default(now()) @db.Timestamptz(6)
  created_by    String
  updated_at    DateTime?  @db.Timestamptz(6)
  updated_by    String?
  mfa_config    mfa_config @relation(fields: [mfa_config_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant        Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, email_address], map: "idx_email_otp_instance_email")
  @@index([mfa_config_id], map: "idx_email_otp_instance_mfa_config")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entitlement {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id       String           @db.Uuid
  principal_id    String?          @db.Uuid
  role_id         String?          @db.Uuid
  group_id        String?          @db.Uuid
  capability      String
  resource_type   String?
  resource_id     String?
  effect          String           @default("allow")
  granted_at      DateTime         @default(now()) @db.Timestamptz(6)
  granted_by      String?
  expires_at      DateTime?        @db.Timestamptz(6)
  metadata        Json?
  principal_group principal_group? @relation(fields: [group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal       Principal?       @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  role            Role?            @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant          Tenant           @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, capability], map: "idx_entitlement_capability")
  @@index([tenant_id, group_id], map: "idx_entitlement_group")
  @@index([tenant_id, principal_id], map: "idx_entitlement_principal")
  @@index([tenant_id, role_id], map: "idx_entitlement_role")
  @@index([expires_at], map: "idx_entitlement_expires", where: raw("(expires_at IS NOT NULL)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_tag {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  entity_type String
  entity_id   String   @db.Uuid
  tag_key     String
  tag_value   String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  created_by  String
  tenant      Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([entity_type, entity_id, tag_key], map: "entity_tag_entity_tag_uniq")
  @@index([tenant_id, entity_type, entity_id], map: "idx_entity_tag_entity")
  @@index([tenant_id, tag_key, tag_value], map: "idx_entity_tag_key_value")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model feature_flag {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String    @db.Uuid
  flag_key    String
  flag_name   String?
  description String?
  is_enabled  Boolean   @default(false)
  enabled_at  DateTime? @db.Timestamptz(6)
  disabled_at DateTime? @db.Timestamptz(6)
  rollout_pct Int?      @default(100)
  config      Json?
  metadata    Json?
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_by  String
  updated_at  DateTime? @db.Timestamptz(6)
  updated_by  String?
  tenant      Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, flag_key], map: "feature_flag_tenant_key_uniq")
  @@index([tenant_id, is_enabled], map: "idx_feature_flag_tenant_enabled")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model field_access_log {
  id                    String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id             String                 @db.Uuid
  entity_key            String
  record_id             String?                @db.Uuid
  subject_id            String                 @db.Uuid
  subject_type          String
  action                String
  field_path            String
  was_allowed           Boolean
  mask_applied          String?
  policy_id             String?                @db.Uuid
  request_id            String?
  trace_id              String?
  correlation_id        String?
  created_at            DateTime               @default(now()) @db.Timestamptz(6)
  field_security_policy field_security_policy? @relation(fields: [policy_id], references: [id], onUpdate: NoAction, map: "field_access_log_policy_fk")
  tenant                Tenant                 @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_key, created_at(sort: Desc)], map: "idx_field_access_log_entity")
  @@index([tenant_id, subject_id, created_at(sort: Desc)], map: "idx_field_access_log_subject")
  @@index([tenant_id, entity_key, record_id, created_at(sort: Desc)], map: "idx_field_access_entity_timeline")
  @@index([tenant_id, created_at(sort: Desc)], map: "idx_field_access_log_denied", where: raw("(was_allowed = false)"))
  @@index([policy_id], map: "idx_field_access_log_policy", where: raw("(policy_id IS NOT NULL)"))
  @@index([record_id], map: "idx_field_access_log_record", where: raw("(record_id IS NOT NULL)"))
  @@index([request_id], map: "idx_field_access_log_request", where: raw("(request_id IS NOT NULL)"))
  @@index([tenant_id, created_at(sort: Desc), action, field_path, was_allowed, subject_id, entity_key, record_id], map: "idx_field_access_timeline")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model job {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String    @db.Uuid
  code          String
  name          String
  schedule_kind String
  schedule_expr String?
  is_active     Boolean   @default(true)
  config        Json?
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  created_by    String
  updated_at    DateTime? @db.Timestamptz(6)
  updated_by    String?
  tenant        Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  job_run       job_run[]

  @@unique([tenant_id, code], map: "job_code_uniq")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model job_run {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  job_id       String    @db.Uuid
  status       String    @default("queued")
  started_at   DateTime? @db.Timestamptz(6)
  finished_at  DateTime? @db.Timestamptz(6)
  attempts     Int       @default(0)
  max_attempts Int       @default(3)
  log_ref      String?
  last_error   String?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  job          job       @relation(fields: [job_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, job_id, created_at(sort: Desc)], map: "idx_job_run_tenant_job_time")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model core_lifecycle {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String              @db.Uuid
  code              String
  name              String
  description       String?
  entity_type       String
  definition        Json                @default("{\"states\": [], \"transitions\": []}")
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  created_by        String
  updated_at        DateTime?           @db.Timestamptz(6)
  updated_by        String?
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_version lifecycle_version[]
  workflow_instance workflow_instance[]

  @@unique([tenant_id, code], map: "lifecycle_tenant_code_uniq")
  @@index([tenant_id, entity_type], map: "idx_lifecycle_entity_type")
  @@index([tenant_id], map: "idx_lifecycle_tenant")
  @@map("lifecycle")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model lifecycle_version {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String              @db.Uuid
  lifecycle_id      String              @db.Uuid
  version           Int
  definition        Json
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  created_by        String
  lifecycle         core_lifecycle      @relation(fields: [lifecycle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workflow_instance workflow_instance[]

  @@unique([lifecycle_id, version], map: "lifecycle_version_lc_ver_uniq")
  @@index([lifecycle_id, version(sort: Desc)], map: "idx_lifecycle_version_lifecycle")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model mfa_challenge {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id      String    @db.Uuid
  principal_id   String    @db.Uuid
  challenge_type String
  challenge_data Json
  secret         String
  attempts       Int       @default(0)
  max_attempts   Int       @default(3)
  status         String    @default("pending")
  verified_at    DateTime? @db.Timestamptz(6)
  expires_at     DateTime  @default(dbgenerated("(now() + '00:10:00'::interval)")) @db.Timestamptz(6)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  created_by     String
  principal      Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant         Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, principal_id, status], map: "idx_mfa_challenge_principal")
  @@index([expires_at], map: "idx_mfa_challenge_expires", where: raw("(status = 'pending'::text)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model has constraints using non-default deferring rules and requires additional setup for migrations. Visit https://pris.ly/d/constraint-deferring for more info.
model mfa_config {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String                @db.Uuid
  principal_id        String                @db.Uuid
  method_type         String
  is_enabled          Boolean               @default(false)
  is_verified         Boolean               @default(false)
  is_primary          Boolean               @default(false)
  secret              String?
  backup_codes        String[]
  device_name         String?
  device_id           String?
  device_info         Json?
  last_used_at        DateTime?             @db.Timestamptz(6)
  verified_at         DateTime?             @db.Timestamptz(6)
  metadata            Json?
  created_at          DateTime              @default(now()) @db.Timestamptz(6)
  created_by          String
  updated_at          DateTime?             @db.Timestamptz(6)
  updated_by          String?
  email_otp_instance  email_otp_instance[]
  principal           Principal             @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant              Tenant                @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sms_otp_instance    sms_otp_instance[]
  totp_instance       totp_instance[]
  webauthn_credential webauthn_credential[]

  @@unique([principal_id, method_type], map: "mfa_config_principal_method_uniq")
  @@index([tenant_id, principal_id], map: "idx_mfa_config_principal")
  @@index([tenant_id, principal_id], map: "idx_mfa_config_enabled", where: raw("(is_enabled = true)"))
  @@index([principal_id], map: "idx_mfa_config_primary", where: raw("(is_primary = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model module {
  id                         String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                       String                       @unique
  name                       String
  description                String?
  workspace_id               String?                      @db.Uuid
  config                     Json?
  created_at                 DateTime                     @default(now()) @db.Timestamptz(6)
  created_by                 String                       @default("system")
  updated_at                 DateTime?                    @db.Timestamptz(6)
  updated_by                 String?
  workspace                  workspace?                   @relation(fields: [workspace_id], references: [id], onUpdate: NoAction, map: "module_workspace_fk")
  tenant_module_subscription tenant_module_subscription[]

  @@index([code], map: "idx_module_code")
  @@index([workspace_id], map: "idx_module_workspace", where: raw("(workspace_id IS NOT NULL)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model operation {
  id                 String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  category_id        String                    @db.Uuid
  code               String
  name               String
  description        String?
  requires_record    Boolean                   @default(false)
  requires_ownership Boolean                   @default(false)
  sort_order         Int                       @default(0)
  created_at         DateTime                  @default(now()) @db.Timestamptz(6)
  created_by         String                    @default("system")
  updated_at         DateTime?                 @db.Timestamptz(6)
  updated_by         String?
  operation_category operation_category        @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  persona_capability persona_capability[]
  ruleOperations     PermissionRuleOperation[]

  @@unique([category_id, code], map: "operation_category_code_uniq")
  @@index([category_id], map: "idx_operation_category")
  @@index([code], map: "idx_operation_code")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model operation_category {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String      @unique
  name        String
  description String?
  sort_order  Int         @default(0)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  created_by  String      @default("system")
  updated_at  DateTime?   @db.Timestamptz(6)
  updated_by  String?
  operation   operation[]

  @@index([sort_order], map: "idx_operation_category_sort")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model organizational_unit {
  id                        String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                 String                @db.Uuid
  code                      String
  name                      String
  description               String?
  parent_id                 String?               @db.Uuid
  metadata                  Json?
  created_at                DateTime              @default(now()) @db.Timestamptz(6)
  created_by                String
  updated_at                DateTime?             @db.Timestamptz(6)
  updated_by                String?
  organizational_unit       organizational_unit?  @relation("organizational_unitToorganizational_unit", fields: [parent_id], references: [id], onUpdate: NoAction)
  other_organizational_unit organizational_unit[] @relation("organizational_unitToorganizational_unit")
  tenant                    Tenant                @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal_ou              principal_ou[]
  employee                  employee[]

  @@unique([tenant_id, code], map: "organizational_unit_tenant_code_uniq")
  @@index([parent_id], map: "idx_ou_parent")
  @@index([tenant_id], map: "idx_ou_tenant")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model outbox {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  topic        String
  event_key    String?
  payload      Json
  status       String    @default("pending")
  attempts     Int       @default(0)
  available_at DateTime  @default(now()) @db.Timestamptz(6)
  locked_at    DateTime? @db.Timestamptz(6)
  locked_by    String?
  last_error   String?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, status, available_at], map: "idx_outbox_pick")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model password_history {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String    @db.Uuid
  principal_id  String    @db.Uuid
  password_hash String
  changed_at    DateTime  @default(now()) @db.Timestamptz(6)
  changed_by    String
  principal     Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant        Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, principal_id, changed_at(sort: Desc)], map: "idx_password_history_principal")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model persona {
  id                         String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                       String                       @unique
  name                       String
  description                String?
  scope_mode                 String                       @default("tenant")
  priority                   Int                          @default(0)
  is_system                  Boolean                      @default(false)
  created_at                 DateTime                     @default(now()) @db.Timestamptz(6)
  created_by                 String                       @default("system")
  updated_at                 DateTime?                    @db.Timestamptz(6)
  updated_by                 String?
  persona_capability         persona_capability[]
  principal_workspace_access principal_workspace_access[]

  @@index([scope_mode], map: "idx_persona_scope_mode")
  @@index([is_system], map: "idx_persona_system", where: raw("(is_system = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model persona_capability {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  persona_id      String    @db.Uuid
  operation_id    String    @db.Uuid
  is_granted      Boolean   @default(true)
  constraint_type String    @default("none")
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @db.Timestamptz(6)
  operation       operation @relation(fields: [operation_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  persona         persona   @relation(fields: [persona_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([persona_id, operation_id], map: "persona_capability_persona_op_uniq")
  @@index([operation_id], map: "idx_persona_capability_operation")
  @@index([persona_id], map: "idx_persona_capability_persona")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model principal_group {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String        @db.Uuid
  code        String
  name        String
  description String?
  metadata    Json?
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  created_by  String
  updated_at  DateTime?     @db.Timestamptz(6)
  updated_by  String?
  entitlement entitlement[]
  members     GroupMember[]
  tenant      Tenant        @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "principal_group_tenant_code_uniq")
  @@index([tenant_id], map: "idx_principal_group_tenant")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model principal_locale_override {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id             String    @db.Uuid
  principal_id          String    @unique(map: "principal_locale_override_principal_uniq") @db.Uuid
  preferred_locale      String
  preferred_timezone    String
  preferred_currency    String?
  preferred_date_format String?
  preferred_time_format String?
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  created_by            String
  updated_at            DateTime? @db.Timestamptz(6)
  updated_by            String?
  principal             Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([principal_id], map: "idx_principal_locale_override_principal")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model principal_ou {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String              @db.Uuid
  principal_id        String              @db.Uuid
  ou_id               String              @db.Uuid
  assigned_at         DateTime            @default(now()) @db.Timestamptz(6)
  assigned_by         String?
  organizational_unit organizational_unit @relation(fields: [ou_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal           Principal           @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant              Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([principal_id, ou_id], map: "principal_ou_principal_ou_uniq")
  @@index([tenant_id, ou_id], map: "idx_principal_ou_ou")
  @@index([tenant_id, principal_id], map: "idx_principal_ou_principal")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model principal_role {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  role_id      String    @db.Uuid
  assigned_at  DateTime  @default(now()) @db.Timestamptz(6)
  assigned_by  String?
  expires_at   DateTime? @db.Timestamptz(6)
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  role         Role      @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([principal_id, role_id], map: "principal_role_principal_role_uniq")
  @@index([tenant_id, principal_id], map: "idx_principal_role_principal")
  @@index([tenant_id, role_id], map: "idx_principal_role_role")
  @@index([expires_at], map: "idx_principal_role_expires", where: raw("(expires_at IS NOT NULL)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model principal_workspace_access {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  workspace_id String    @db.Uuid
  role_id      String?   @db.Uuid
  persona_id   String?   @db.Uuid
  access_level String    @default("member")
  granted_at   DateTime  @default(now()) @db.Timestamptz(6)
  granted_by   String?
  expires_at   DateTime? @db.Timestamptz(6)
  metadata     Json?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  updated_at   DateTime? @db.Timestamptz(6)
  updated_by   String?
  persona      persona?  @relation(fields: [persona_id], references: [id], onUpdate: NoAction)
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  role         Role?     @relation(fields: [role_id], references: [id], onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([principal_id, workspace_id], map: "principal_workspace_access_uniq")
  @@index([access_level], map: "idx_principal_workspace_access_access_level")
  @@index([principal_id], map: "idx_principal_workspace_access_principal")
  @@index([role_id], map: "idx_principal_workspace_access_role")
  @@index([workspace_id], map: "idx_principal_workspace_access_workspace")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model security_event {
  id             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id      String     @db.Uuid
  principal_id   String?    @db.Uuid
  event_type     String
  severity       String     @default("info")
  occurred_at    DateTime   @default(now()) @db.Timestamptz(6)
  ip_address     String?
  user_agent     String?
  correlation_id String?
  details        Json?
  created_at     DateTime   @default(now()) @db.Timestamptz(6)
  principal      Principal? @relation(fields: [principal_id], references: [id], onUpdate: NoAction)
  tenant         Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, principal_id], map: "idx_security_event_principal")
  @@index([tenant_id, occurred_at(sort: Desc)], map: "idx_security_event_tenant_time")
  @@index([tenant_id, event_type], map: "idx_security_event_type")
  @@index([tenant_id, occurred_at(sort: Desc), event_type, severity, principal_id, details], map: "idx_security_event_timeline")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model sms_otp_instance {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String     @db.Uuid
  mfa_config_id String     @db.Uuid
  phone_number  String
  verified_at   DateTime?  @db.Timestamptz(6)
  created_at    DateTime   @default(now()) @db.Timestamptz(6)
  created_by    String
  updated_at    DateTime?  @db.Timestamptz(6)
  updated_by    String?
  mfa_config    mfa_config @relation(fields: [mfa_config_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant        Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([mfa_config_id], map: "idx_sms_otp_instance_mfa_config")
  @@index([tenant_id, phone_number], map: "idx_sms_otp_instance_phone")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model system_config {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String?   @db.Uuid
  config_key   String
  config_value String
  config_type  String    @default("string")
  description  String?
  is_encrypted Boolean   @default(false)
  is_global    Boolean   @default(false)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  updated_at   DateTime? @db.Timestamptz(6)
  updated_by   String?
  tenant       Tenant?   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, config_key], map: "idx_system_config_tenant_key")
  @@index([config_key], map: "idx_system_config_global", where: raw("(is_global = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model tenant_locale_policy {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id             String    @db.Uuid
  code                  String
  name                  String?
  default_locale        String    @default("en-US")
  default_timezone      String    @default("UTC")
  default_currency      String    @default("USD")
  default_date_format   String    @default("MM/dd/yyyy")
  default_time_format   String    @default("hh:mm:ss a")
  default_decimal_sep   String    @default(".")
  default_thousands_sep String    @default(",")
  data_residency        String?
  language_requirements String[]
  phone_format_hint     String?
  postal_code_pattern   String?
  metadata              Json?
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  created_by            String
  updated_at            DateTime? @db.Timestamptz(6)
  updated_by            String?
  tenant                Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "tenant_locale_policy_tenant_code_uniq")
  @@index([tenant_id, code], map: "idx_tenant_locale_policy_code")
  @@index([tenant_id], map: "idx_tenant_locale_policy_tenant")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model tenant_module_subscription {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id  String    @db.Uuid
  module_id  String    @db.Uuid
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  created_by String    @default("system")
  updated_at DateTime? @db.Timestamptz(6)
  updated_by String?
  module     module    @relation(fields: [module_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant     Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, module_id], map: "tenant_module_subscription_uniq")
  @@index([module_id], map: "idx_tenant_module_sub_module")
  @@index([tenant_id], map: "idx_tenant_module_sub_tenant")
  @@index([tenant_id, is_active], map: "idx_tenant_module_sub_active", where: raw("(is_active = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model totp_instance {
  id               String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String     @db.Uuid
  mfa_config_id    String     @db.Uuid
  secret           String
  algorithm        String     @default("SHA1")
  digits           Int        @default(6)
  period           Int        @default(30)
  qr_code_url      String?
  manual_entry_key String?
  last_counter     Int?
  last_verified_at DateTime?  @db.Timestamptz(6)
  created_at       DateTime   @default(now()) @db.Timestamptz(6)
  created_by       String
  mfa_config       mfa_config @relation(fields: [mfa_config_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant           Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([mfa_config_id], map: "idx_totp_instance_mfa_config")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model has constraints using non-default deferring rules and requires additional setup for migrations. Visit https://pris.ly/d/constraint-deferring for more info.
model trusted_device {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String    @db.Uuid
  principal_id       String    @db.Uuid
  device_id          String
  device_fingerprint String?
  device_name        String?
  device_type        String?
  user_agent         String?
  ip_address         String?
  is_trusted         Boolean   @default(false)
  last_seen_at       DateTime? @db.Timestamptz(6)
  verified_at        DateTime? @db.Timestamptz(6)
  expires_at         DateTime? @db.Timestamptz(6)
  metadata           Json?
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  created_by         String
  principal          Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant             Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([principal_id, device_id], map: "trusted_device_principal_id_uniq")
  @@index([tenant_id, device_fingerprint], map: "idx_trusted_device_fingerprint")
  @@index([tenant_id, principal_id], map: "idx_trusted_device_principal")
  @@index([tenant_id, principal_id], map: "idx_trusted_device_trusted", where: raw("(is_trusted = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model webauthn_credential {
  id                         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                  String     @db.Uuid
  mfa_config_id              String     @db.Uuid
  credential_id              Bytes
  public_key                 String
  counter                    BigInt?
  aaguid                     String?    @db.Uuid
  attestation                String?
  transports                 String[]
  is_backup_eligible         Boolean?
  is_backup_state            Boolean?
  is_discoverable_credential Boolean?
  last_used_at               DateTime?  @db.Timestamptz(6)
  verified_at                DateTime?  @db.Timestamptz(6)
  created_at                 DateTime   @default(now()) @db.Timestamptz(6)
  created_by                 String
  mfa_config                 mfa_config @relation(fields: [mfa_config_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                     Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, credential_id], map: "webauthn_credential_id_uniq")
  @@index([mfa_config_id], map: "idx_webauthn_credential_mfa_config")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model workflow_instance {
  id                                                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                           String                @db.Uuid
  entity_type                                         String
  entity_id                                           String                @db.Uuid
  entity_version_id                                   String?               @db.Uuid
  lifecycle_id                                        String                @db.Uuid
  lifecycle_version_id                                String                @db.Uuid
  current_state                                       String
  previous_state                                      String?
  status                                              String                @default("active")
  data                                                Json?
  context                                             Json?
  initiated_by                                        String?               @db.Uuid
  initiated_at                                        DateTime              @default(now()) @db.Timestamptz(6)
  completed_by                                        String?               @db.Uuid
  completed_at                                        DateTime?             @db.Timestamptz(6)
  created_at                                          DateTime              @default(now()) @db.Timestamptz(6)
  created_by                                          String
  updated_at                                          DateTime?             @db.Timestamptz(6)
  updated_by                                          String?
  principal_workflow_instance_completed_byToprincipal Principal?            @relation("workflow_instance_completed_byToprincipal", fields: [completed_by], references: [id], onUpdate: NoAction)
  principal_workflow_instance_initiated_byToprincipal Principal?            @relation("workflow_instance_initiated_byToprincipal", fields: [initiated_by], references: [id], onUpdate: NoAction)
  lifecycle                                           core_lifecycle        @relation(fields: [lifecycle_id], references: [id], onUpdate: NoAction)
  lifecycle_version                                   lifecycle_version     @relation(fields: [lifecycle_version_id], references: [id], onUpdate: NoAction)
  tenant                                              Tenant                @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workflow_transition                                 workflow_transition[]

  @@unique([entity_type, entity_id], map: "workflow_instance_entity_uniq")
  @@index([tenant_id, current_state], map: "idx_workflow_instance_current_state")
  @@index([tenant_id, entity_type, entity_id], map: "idx_workflow_instance_entity")
  @@index([tenant_id, status], map: "idx_workflow_instance_tenant_status")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model workflow_transition {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String            @db.Uuid
  workflow_instance_id String            @db.Uuid
  from_state           String
  to_state             String
  transition_name      String?
  transition_data      Json?
  triggered_by         String            @db.Uuid
  triggered_at         DateTime          @default(now()) @db.Timestamptz(6)
  created_at           DateTime          @default(now()) @db.Timestamptz(6)
  tenant               Tenant            @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal            Principal         @relation(fields: [triggered_by], references: [id], onDelete: SetNull, onUpdate: NoAction)
  workflow_instance    workflow_instance @relation(fields: [workflow_instance_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([workflow_instance_id, triggered_at(sort: Desc)], map: "idx_workflow_transition_instance")
  @@index([tenant_id, triggered_at(sort: Desc)], map: "idx_workflow_transition_tenant_time")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model workspace {
  id                         String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code                       String                       @unique
  name                       String
  description                String?
  sort_order                 Int                          @default(0)
  metadata                   Json?
  created_at                 DateTime                     @default(now()) @db.Timestamptz(6)
  created_by                 String                       @default("system")
  updated_at                 DateTime?                    @db.Timestamptz(6)
  updated_by                 String?
  module                     module[]
  principal_workspace_access principal_workspace_access[]
  workspace_feature          workspace_feature[]
  workspace_usage_metric     workspace_usage_metric[]

  @@index([sort_order], map: "idx_workspace_sort")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model workspace_feature {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  workspace_id String    @db.Uuid
  feature_code String
  feature_name String?
  is_enabled   Boolean   @default(true)
  enabled_at   DateTime? @db.Timestamptz(6)
  config       Json?
  metadata     Json?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  updated_at   DateTime? @db.Timestamptz(6)
  updated_by   String?
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workspace_id, feature_code], map: "workspace_feature_ws_feat_uniq")
  @@index([feature_code], map: "idx_workspace_feature_code")
  @@index([workspace_id, is_enabled], map: "idx_workspace_feature_workspace")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model workspace_usage_metric {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  workspace_id String    @db.Uuid
  metric_key   String
  metric_name  String?
  metric_value Decimal?  @db.Decimal
  metric_unit  String?
  period_start DateTime  @db.Timestamptz(6)
  period_end   DateTime? @db.Timestamptz(6)
  recorded_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workspace    workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([workspace_id, metric_key, period_end(sort: Desc)], map: "idx_workspace_usage_metric_metric_key")
  @@index([workspace_id, period_end(sort: Desc)], map: "idx_workspace_usage_metric_workspace")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_sla_policy {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String   @db.Uuid
  code             String
  name             String
  timers           Json
  escalation_chain Json?
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  created_by       String
  tenant           Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "approval_sla_code_uniq")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_template {
  id                      String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id               String                    @db.Uuid
  code                    String
  name                    String
  behaviors               Json?
  escalation_style        String?
  created_at              DateTime                  @default(now()) @db.Timestamptz(6)
  created_by              String
  version_no              Int                       @default(1)
  is_active               Boolean                   @default(true)
  updated_at              DateTime?                 @db.Timestamptz(6)
  updated_by              String?
  compiled_json           Json?
  compiled_hash           String?
  tenant                  Tenant                    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  approval_template_rule  approval_template_rule[]
  approval_template_stage approval_template_stage[]

  @@unique([tenant_id, code, version_no], map: "approval_template_code_version_uniq")
  @@index([tenant_id, code, is_active], map: "idx_approval_template_active", where: raw("(is_active = true)"))
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_template_rule {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String            @db.Uuid
  approval_template_id String            @db.Uuid
  priority             Int               @default(100)
  conditions           Json
  assign_to            Json
  created_at           DateTime          @default(now()) @db.Timestamptz(6)
  created_by           String
  approval_template    approval_template @relation(fields: [approval_template_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant               Tenant            @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, approval_template_id, priority], map: "idx_approval_template_rule")
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model approval_template_stage {
  id                   String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String            @db.Uuid
  approval_template_id String            @db.Uuid
  stage_no             Int
  name                 String?
  mode                 String            @default("serial")
  quorum               Json?
  created_at           DateTime          @default(now()) @db.Timestamptz(6)
  created_by           String
  approval_template    approval_template @relation(fields: [approval_template_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant               Tenant            @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, approval_template_id, stage_no], map: "template_stage_uniq")
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id             String                  @db.Uuid
  module_id             String
  name                  String
  kind                  String                  @default("ent")
  table_schema          String                  @default("ent")
  table_name            String
  naming_policy         Json?
  feature_flags         Json?
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  created_by            String
  updated_at            DateTime?               @db.Timestamptz(6)
  updated_by            String?
  tenant                Tenant                  @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  entity_policy         entity_policy[]
  entity_version        entity_version[]
  field_security_policy field_security_policy[]
  overlay               overlay[]

  @@unique([tenant_id, name], map: "entity_name_uniq")
  @@index([tenant_id, module_id], map: "idx_entity_module")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_compiled {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String         @db.Uuid
  entity_version_id String         @db.Uuid
  compiled_json     Json
  compiled_hash     String
  generated_at      DateTime       @default(now()) @db.Timestamptz(6)
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  created_by        String
  entity_version    entity_version @relation(fields: [entity_version_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_version_id, compiled_hash], map: "entity_compiled_hash_uniq")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_compiled_overlay {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String         @db.Uuid
  entity_version_id String         @db.Uuid
  overlay_set       Json
  compiled_json     Json
  compiled_hash     String
  generated_at      DateTime       @default(now()) @db.Timestamptz(6)
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  created_by        String
  entity_version    entity_version @relation(fields: [entity_version_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_version_id, compiled_hash], map: "idx_entity_compiled_overlay_lookup")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_lifecycle {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String         @db.Uuid
  entity_name  String
  lifecycle_id String         @db.Uuid
  conditions   Json?
  priority     Int            @default(100)
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  created_by   String
  lifecycle    meta_lifecycle @relation(fields: [lifecycle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_name, priority], map: "idx_entity_lifecycle_resolution")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_lifecycle_route_compiled {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String   @db.Uuid
  entity_name   String
  compiled_json Json
  compiled_hash String
  generated_at  DateTime @default(now()) @db.Timestamptz(6)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  created_by    String
  tenant        Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_name, compiled_hash], map: "route_compiled_hash_uniq")
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_policy {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String          @db.Uuid
  entity_id         String?         @db.Uuid
  entity_version_id String?         @db.Uuid
  access_mode       String          @default("default_deny")
  ou_scope_mode     String          @default("none")
  audit_mode        String          @default("enabled")
  retention_policy  Json?
  default_filters   Json?
  cache_flags       Json?
  created_at        DateTime        @default(now()) @db.Timestamptz(6)
  created_by        String
  updated_at        DateTime?       @db.Timestamptz(6)
  updated_by        String?
  entity            entity?         @relation(fields: [entity_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  entity_version    entity_version? @relation(fields: [entity_version_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant          @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_id], map: "idx_entity_policy_entity", where: raw("(entity_id IS NOT NULL)"))
  @@index([tenant_id, entity_version_id], map: "idx_entity_policy_version", where: raw("(entity_version_id IS NOT NULL)"))
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_version {
  id                      String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id               String                    @db.Uuid
  entity_id               String                    @db.Uuid
  version_no              Int                       @default(1)
  status                  String                    @default("draft")
  label                   String?
  behaviors               Json?
  published_at            DateTime?                 @db.Timestamptz(6)
  published_by            String?
  created_at              DateTime                  @default(now()) @db.Timestamptz(6)
  created_by              String
  updated_at              DateTime?                 @db.Timestamptz(6)
  updated_by              String?
  entity_compiled         entity_compiled[]
  entity_compiled_overlay entity_compiled_overlay[]
  entity_policy           entity_policy[]
  entity                  entity                    @relation(fields: [entity_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                  Tenant                    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  field                   field[]
  index_def               index_def[]
  overlay                 overlay[]
  relation                relation[]

  @@unique([tenant_id, entity_id, version_no], map: "entity_version_uniq")
  @@index([tenant_id, entity_id, status], map: "idx_entity_version_entity_status")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model field {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String         @db.Uuid
  entity_version_id  String         @db.Uuid
  name               String
  column_name        String?
  data_type          String
  ui_type            String?
  is_required        Boolean        @default(false)
  is_unique          Boolean        @default(false)
  is_searchable      Boolean        @default(false)
  is_filterable      Boolean        @default(false)
  default_value      Json?
  validation         Json?
  lookup_config      Json?
  sort_order         Int            @default(0)
  is_active          Boolean        @default(true)
  created_at         DateTime       @default(now()) @db.Timestamptz(6)
  created_by         String
  updated_at         DateTime?      @db.Timestamptz(6)
  updated_by         String?
  validation_version Int            @default(1)
  entity_version     entity_version @relation(fields: [entity_version_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant             Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_version_id, name], map: "field_name_uniq")
  @@index([tenant_id, entity_version_id], map: "idx_field_entity_version")
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model field_security_policy {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String             @db.Uuid
  entity_id        String             @db.Uuid
  field_path       String
  policy_type      String
  role_list        String[]
  abac_condition   Json?
  mask_strategy    String?
  mask_config      Json?
  scope            String             @default("entity")
  scope_ref        String?            @db.Uuid
  priority         Int                @default(100)
  is_active        Boolean            @default(true)
  metadata         Json?
  created_at       DateTime           @default(now()) @db.Timestamptz(6)
  created_by       String
  updated_at       DateTime?          @db.Timestamptz(6)
  updated_by       String?
  version          Int                @default(1)
  field_access_log field_access_log[]
  entity           entity             @relation(fields: [entity_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant           Tenant             @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_id, field_path, policy_type, scope, scope_ref], map: "field_security_policy_uniq")
  @@index([tenant_id, entity_id], map: "idx_field_security_entity")
  @@index([field_path], map: "idx_field_security_field")
  @@index([tenant_id, entity_id, field_path, policy_type, is_active], map: "idx_field_security_lookup")
  @@index([entity_id, priority], map: "idx_field_security_priority")
  @@index([scope, scope_ref], map: "idx_field_security_scope")
  @@index([policy_type], map: "idx_field_security_type")
  @@index([is_active], map: "idx_field_security_active", where: raw("(is_active = true)"))
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model index_def {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String         @db.Uuid
  entity_version_id String         @db.Uuid
  name              String
  is_unique         Boolean        @default(false)
  method            String         @default("btree")
  columns           Json
  where_clause      String?
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  created_by        String
  entity_version    entity_version @relation(fields: [entity_version_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_version_id, name], map: "index_def_name_uniq")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model meta_lifecycle {
  id                       String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                String                     @db.Uuid
  code                     String
  name                     String
  description              String?
  version_no               Int                        @default(1)
  is_active                Boolean                    @default(true)
  config                   Json?
  created_at               DateTime                   @default(now()) @db.Timestamptz(6)
  created_by               String
  lifecycle_timer_schedule lifecycle_timer_schedule[]
  entity_lifecycle         entity_lifecycle[]
  tenant                   Tenant                     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_state          lifecycle_state[]
  lifecycle_transition     lifecycle_transition[]

  @@unique([tenant_id, code, version_no], map: "lifecycle_code_uniq")
  @@map("lifecycle")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model lifecycle_state {
  id                                                                       String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                                                String                     @db.Uuid
  lifecycle_id                                                             String                     @db.Uuid
  code                                                                     String
  name                                                                     String
  is_terminal                                                              Boolean                    @default(false)
  sort_order                                                               Int                        @default(0)
  config                                                                   Json?
  created_at                                                               DateTime                   @default(now()) @db.Timestamptz(6)
  created_by                                                               String
  lifecycle_timer_schedule                                                 lifecycle_timer_schedule[]
  lifecycle                                                                meta_lifecycle             @relation(fields: [lifecycle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                                                                   Tenant                     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_transition_lifecycle_transition_from_state_idTolifecycle_state lifecycle_transition[]     @relation("lifecycle_transition_from_state_idTolifecycle_state")
  lifecycle_transition_lifecycle_transition_to_state_idTolifecycle_state   lifecycle_transition[]     @relation("lifecycle_transition_to_state_idTolifecycle_state")

  @@unique([tenant_id, lifecycle_id, code], map: "lifecycle_state_code_uniq")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model lifecycle_timer_policy {
  id                       String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                String                     @db.Uuid
  code                     String
  name                     String
  rules                    Json
  created_at               DateTime                   @default(now()) @db.Timestamptz(6)
  created_by               String
  lifecycle_timer_schedule lifecycle_timer_schedule[]
  tenant                   Tenant                     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "lifecycle_timer_policy_code_uniq")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model lifecycle_transition {
  id                                                                  String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                                           String                      @db.Uuid
  lifecycle_id                                                        String                      @db.Uuid
  from_state_id                                                       String                      @db.Uuid
  to_state_id                                                         String                      @db.Uuid
  operation_code                                                      String
  is_active                                                           Boolean                     @default(true)
  config                                                              Json?
  created_at                                                          DateTime                    @default(now()) @db.Timestamptz(6)
  created_by                                                          String
  lifecycle_timer_schedule                                            lifecycle_timer_schedule[]
  lifecycle_state_lifecycle_transition_from_state_idTolifecycle_state lifecycle_state             @relation("lifecycle_transition_from_state_idTolifecycle_state", fields: [from_state_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle                                                           meta_lifecycle              @relation(fields: [lifecycle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                                                              Tenant                      @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_state_lifecycle_transition_to_state_idTolifecycle_state   lifecycle_state             @relation("lifecycle_transition_to_state_idTolifecycle_state", fields: [to_state_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_transition_gate                                           lifecycle_transition_gate[]

  @@index([tenant_id, lifecycle_id, from_state_id, operation_code], map: "idx_transition_lookup")
  @@schema("meta")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model lifecycle_transition_gate {
  id                   String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String               @db.Uuid
  transition_id        String               @db.Uuid
  required_operations  Json?
  approval_template_id String?              @db.Uuid
  conditions           Json?
  threshold_rules      Json?
  created_at           DateTime             @default(now()) @db.Timestamptz(6)
  created_by           String
  tenant               Tenant               @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_transition lifecycle_transition @relation(fields: [transition_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model overlay {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id       String           @db.Uuid
  overlay_key     String
  description     String?
  base_entity_id  String           @db.Uuid
  base_version_id String?          @db.Uuid
  priority        Int              @default(100)
  conflict_mode   String           @default("fail")
  is_active       Boolean          @default(true)
  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  created_by      String
  updated_at      DateTime?        @db.Timestamptz(6)
  updated_by      String?
  entity          entity           @relation(fields: [base_entity_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  entity_version  entity_version?  @relation(fields: [base_version_id], references: [id], onUpdate: NoAction)
  tenant          Tenant           @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  overlay_change  overlay_change[]

  @@unique([tenant_id, overlay_key], map: "overlay_key_uniq")
  @@index([tenant_id, base_entity_id], map: "idx_overlay_base_entity")
  @@index([base_entity_id, priority], map: "idx_overlay_priority")
  @@index([is_active], map: "idx_overlay_active", where: raw("(is_active = true)"))
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model overlay_change {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String   @db.Uuid
  overlay_id   String   @db.Uuid
  change_order Int
  kind         String
  path         String
  value        Json?
  created_at   DateTime @default(now()) @db.Timestamptz(6)
  created_by   String
  overlay      overlay  @relation(fields: [overlay_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([overlay_id, change_order], map: "overlay_change_order_uniq")
  @@index([overlay_id], map: "idx_overlay_change_overlay")
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model relation {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String         @db.Uuid
  entity_version_id String         @db.Uuid
  name              String
  relation_kind     String
  target_entity     String
  fk_field          String?
  target_key        String?
  on_delete         String         @default("restrict")
  ui_behavior       Json?
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  created_by        String
  entity_version    entity_version @relation(fields: [entity_version_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_version_id, name], map: "relation_name_uniq")
  @@schema("meta")
}

model schema_provisions {
  id          Int      @id @default(autoincrement())
  file_name   String   @unique
  checksum    String
  executed_at DateTime @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model commodity_code {
  domain_code          String
  code                 String
  name                 String
  description          String?
  parent_code          String?
  level_no             Int?
  status               String           @default("active")
  metadata             Json             @default("{}")
  created_at           DateTime         @default(now()) @db.Timestamptz(6)
  created_by           String           @default("seed")
  updated_at           DateTime?        @db.Timestamptz(6)
  updated_by           String?
  commodity_domain     commodity_domain @relation(fields: [domain_code], references: [code], onDelete: Cascade, onUpdate: NoAction)
  commodity_code       commodity_code?  @relation("commodity_codeTocommodity_code", fields: [domain_code, parent_code], references: [domain_code, code], onDelete: NoAction, onUpdate: NoAction, map: "commodity_code_parent_fk")
  other_commodity_code commodity_code[] @relation("commodity_codeTocommodity_code")

  @@id([domain_code, code])
  @@index([domain_code, level_no], map: "idx_commodity_code_level")
  @@index([domain_code, parent_code], map: "idx_commodity_code_parent")
  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model commodity_domain {
  code           String           @id
  name           String
  standard       String?
  version        String?
  status         String           @default("active")
  metadata       Json             @default("{}")
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  created_by     String           @default("seed")
  updated_at     DateTime?        @db.Timestamptz(6)
  updated_by     String?
  commodity_code commodity_code[]

  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model country {
  code2         String         @id @db.Char(2)
  code3         String?        @unique @db.Char(3)
  numeric3      String?        @unique @db.Char(3)
  name          String
  official_name String?
  region        String?
  subregion     String?
  status        String         @default("active")
  metadata      Json           @default("{}")
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  created_by    String         @default("seed")
  updated_at    DateTime?      @db.Timestamptz(6)
  updated_by    String?
  locale        locale[]
  state_region  state_region[]

  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model currency {
  code        String    @id @db.Char(3)
  name        String
  symbol      String?
  minor_units Int?
  numeric3    String?   @unique @db.Char(3)
  status      String    @default("active")
  metadata    Json      @default("{}")
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_by  String    @default("seed")
  updated_at  DateTime? @db.Timestamptz(6)
  updated_by  String?

  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model industry_code {
  domain_code         String
  code                String
  name                String
  description         String?
  parent_code         String?
  level_no            Int?
  status              String          @default("active")
  metadata            Json            @default("{}")
  created_at          DateTime        @default(now()) @db.Timestamptz(6)
  created_by          String          @default("seed")
  updated_at          DateTime?       @db.Timestamptz(6)
  updated_by          String?
  industry_domain     industry_domain @relation(fields: [domain_code], references: [code], onDelete: Cascade, onUpdate: NoAction)
  industry_code       industry_code?  @relation("industry_codeToindustry_code", fields: [domain_code, parent_code], references: [domain_code, code], onDelete: NoAction, onUpdate: NoAction, map: "industry_code_parent_fk")
  other_industry_code industry_code[] @relation("industry_codeToindustry_code")

  @@id([domain_code, code])
  @@index([domain_code, level_no], map: "idx_industry_code_level")
  @@index([domain_code, parent_code], map: "idx_industry_code_parent")
  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model industry_domain {
  code          String          @id
  name          String
  standard      String?
  version       String?
  status        String          @default("active")
  metadata      Json            @default("{}")
  created_at    DateTime        @default(now()) @db.Timestamptz(6)
  created_by    String          @default("seed")
  updated_at    DateTime?       @db.Timestamptz(6)
  updated_by    String?
  industry_code industry_code[]

  @@schema("ref")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model label {
  entity      String
  code        String
  locale_code String
  name        String
  description String?
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_by  String    @default("seed")
  updated_at  DateTime? @db.Timestamptz(6)
  updated_by  String?
  locale      locale    @relation(fields: [locale_code], references: [code], onDelete: NoAction, onUpdate: NoAction)

  @@id([entity, code, locale_code])
  @@index([entity, locale_code], map: "idx_label_entity_locale")
  @@index([locale_code], map: "idx_label_locale")
  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model language {
  code        String    @id
  name        String
  native_name String?
  iso639_2    String?
  direction   String    @default("ltr")
  status      String    @default("active")
  metadata    Json      @default("{}")
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_by  String    @default("seed")
  updated_at  DateTime? @db.Timestamptz(6)
  updated_by  String?
  locale      locale[]

  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model locale {
  code          String    @id
  language_code String
  country_code2 String?   @db.Char(2)
  script        String?
  name          String
  direction     String?
  status        String    @default("active")
  metadata      Json      @default("{}")
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  created_by    String    @default("seed")
  updated_at    DateTime? @db.Timestamptz(6)
  updated_by    String?
  label         label[]
  country       country?  @relation(fields: [country_code2], references: [code2], onDelete: NoAction, onUpdate: NoAction)
  language      language  @relation(fields: [language_code], references: [code], onDelete: NoAction, onUpdate: NoAction)

  @@index([country_code2], map: "idx_locale_country")
  @@index([language_code], map: "idx_locale_language")
  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model state_region {
  code               String         @id
  country_code2      String         @db.Char(2)
  name               String
  category           String?
  parent_code        String?
  status             String         @default("active")
  metadata           Json           @default("{}")
  created_at         DateTime       @default(now()) @db.Timestamptz(6)
  created_by         String         @default("seed")
  updated_at         DateTime?      @db.Timestamptz(6)
  updated_by         String?
  country            country        @relation(fields: [country_code2], references: [code2], onDelete: Cascade, onUpdate: NoAction)
  state_region       state_region?  @relation("state_regionTostate_region", fields: [parent_code], references: [code], onDelete: NoAction, onUpdate: NoAction)
  other_state_region state_region[] @relation("state_regionTostate_region")

  @@index([category], map: "idx_state_region_category")
  @@index([country_code2], map: "idx_state_region_country")
  @@index([parent_code], map: "idx_state_region_parent")
  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model timezone {
  tzid           String     @id
  display_name   String?
  utc_offset     String?
  is_alias       Boolean    @default(false)
  canonical_tzid String?
  status         String     @default("active")
  metadata       Json       @default("{}")
  created_at     DateTime   @default(now()) @db.Timestamptz(6)
  created_by     String     @default("seed")
  updated_at     DateTime?  @db.Timestamptz(6)
  updated_by     String?
  timezone       timezone?  @relation("timezoneTotimezone", fields: [canonical_tzid], references: [tzid], onDelete: NoAction, onUpdate: NoAction)
  other_timezone timezone[] @relation("timezoneTotimezone")

  @@index([canonical_tzid], map: "idx_timezone_canonical")
  @@schema("ref")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model uom {
  code          String    @id
  name          String
  symbol        String?
  quantity_type String?
  status        String    @default("active")
  metadata      Json      @default("{}")
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  created_by    String    @default("seed")
  updated_at    DateTime? @db.Timestamptz(6)
  updated_by    String?

  @@schema("ref")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model dashboard_widget {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  widget_type  String
  widget_name  String?
  description  String?
  position     Json      @default("{\"h\": 3, \"w\": 4, \"x\": 0, \"y\": 0}")
  config       Json?
  data_source  Json?
  is_visible   Boolean   @default(true)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  updated_at   DateTime? @db.Timestamptz(6)
  updated_by   String?
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([principal_id], map: "idx_dashboard_widget_principal")
  @@index([widget_type], map: "idx_dashboard_widget_type")
  @@schema("ui")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model notification {
  id                                             String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                      String     @db.Uuid
  recipient_id                                   String     @db.Uuid
  sender_id                                      String?    @db.Uuid
  channel                                        String     @default("in_app")
  category                                       String?
  priority                                       String     @default("normal")
  title                                          String
  body                                           String?
  icon                                           String?
  action_url                                     String?
  entity_type                                    String?
  entity_id                                      String?    @db.Uuid
  is_read                                        Boolean    @default(false)
  read_at                                        DateTime?  @db.Timestamptz(6)
  is_dismissed                                   Boolean    @default(false)
  dismissed_at                                   DateTime?  @db.Timestamptz(6)
  expires_at                                     DateTime?  @db.Timestamptz(6)
  metadata                                       Json?
  created_at                                     DateTime   @default(now()) @db.Timestamptz(6)
  created_by                                     String
  principal_notification_recipient_idToprincipal Principal  @relation("notification_recipient_idToprincipal", fields: [recipient_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal_notification_sender_idToprincipal    Principal? @relation("notification_sender_idToprincipal", fields: [sender_id], references: [id], onUpdate: NoAction)
  tenant                                         Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_type, entity_id], map: "idx_notification_entity")
  @@index([tenant_id, recipient_id, created_at(sort: Desc)], map: "idx_notification_recipient_time")
  @@index([expires_at], map: "idx_notification_expires", where: raw("(expires_at IS NOT NULL)"))
  @@index([recipient_id, is_read, created_at(sort: Desc)], map: "idx_notification_recipient_unread", where: raw("(is_read = false)"))
  @@schema("ui")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model notification_preference {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  event_code   String
  channel      String
  is_enabled   Boolean   @default(true)
  frequency    String    @default("immediate")
  quiet_hours  Json?
  metadata     Json?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  updated_at   DateTime? @db.Timestamptz(6)
  updated_by   String?
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([principal_id, event_code, channel], map: "notification_preference_principal_event_channel_uniq")
  @@index([event_code, channel], map: "idx_notification_preference_event")
  @@index([principal_id], map: "idx_notification_preference_principal")
  @@schema("ui")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model recent_activity {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  entity_type  String
  entity_id    String    @db.Uuid
  entity_name  String?
  action       String    @default("view")
  accessed_at  DateTime  @default(now()) @db.Timestamptz(6)
  metadata     Json?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_type, entity_id], map: "idx_recent_activity_entity")
  @@index([principal_id, accessed_at(sort: Desc)], map: "idx_recent_activity_principal_time")
  @@schema("ui")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model saved_view {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  entity_type  String
  view_name    String
  description  String?
  is_default   Boolean   @default(false)
  is_shared    Boolean   @default(false)
  filters      Json?
  sort_order   Json?
  columns      Json?
  group_by     Json?
  metadata     Json?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  created_by   String
  updated_at   DateTime? @db.Timestamptz(6)
  updated_by   String?
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([principal_id, entity_type], map: "idx_saved_view_principal_entity")
  @@index([tenant_id, entity_type], map: "idx_saved_view_shared", where: raw("(is_shared = true)"))
  @@schema("ui")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model search_history {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  query_text   String
  entity_type  String?
  result_count Int?
  searched_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  principal    Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([principal_id, searched_at(sort: Desc)], map: "idx_search_history_principal_time")
  @@schema("ui")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model user_preference {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String    @db.Uuid
  principal_id     String    @db.Uuid
  preference_key   String
  preference_value Json
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  created_by       String
  updated_at       DateTime? @db.Timestamptz(6)
  updated_by       String?
  principal        Principal @relation(fields: [principal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant           Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([principal_id, preference_key], map: "user_preference_principal_key_uniq")
  @@index([principal_id], map: "idx_user_preference_principal")
  @@schema("ui")
}

/// Append-only audit trail for approval workflow events. Immutable after insert.
/// This table contains check constraints and requires additional setup for migrations.
model workflow_audit_event {
  id                        String   @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                 String   @db.Uuid
  event_type                String
  severity                  String   @default("info")
  schema_version            Int      @default(1)
  instance_id               String
  step_instance_id          String?
  entity_type               String
  entity_id                 String
  entity                    Json
  workflow                  Json
  actor                     Json
  actor_user_id             String?
  actor_is_admin            Boolean? @default(false)
  workflow_template_code    String?
  workflow_template_version Int?
  module_code               String?  @default("WF")
  action                    String?
  previous_state            Json?
  new_state                 Json?
  comment                   String?
  attachments               Json?
  details                   Json?
  ip_address                String?
  user_agent                String?
  correlation_id            String?
  session_id                String?
  trace_id                  String?
  hash_prev                 String?
  hash_curr                 String?
  is_redacted               Boolean? @default(false)
  redaction_version         Int?
  event_timestamp           DateTime @db.Timestamptz(6)
  created_at                DateTime @default(now()) @db.Timestamptz(6)
  key_version               Int?
  tenant                    Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "wf_audit_tenant_fk")

  @@id([id, event_timestamp])
  @@unique([tenant_id, correlation_id, event_timestamp, event_type, actor_user_id], map: "idx_audit_event_dedup", where: raw("(correlation_id IS NOT NULL)"))
  @@index([tenant_id, event_timestamp(sort: Desc)], map: "idx_wf_audit_tenant_time")
  @@index([tenant_id, instance_id, event_timestamp], map: "idx_wf_audit_instance")
  @@index([tenant_id, event_type, event_timestamp(sort: Desc)], map: "idx_wf_audit_event_type")
  @@index([tenant_id, entity_type, entity_id], map: "idx_wf_audit_entity")
  @@index([tenant_id, actor_user_id, event_timestamp(sort: Desc)], map: "idx_wf_audit_actor")
  @@index([tenant_id, workflow_template_code], map: "idx_wf_audit_template")
  @@index([tenant_id, key_version], map: "idx_audit_event_key_version", where: raw("(key_version IS NOT NULL)"))
  @@index([tenant_id, correlation_id], map: "idx_wf_audit_correlation", where: raw("(correlation_id IS NOT NULL)"))
  @@index([details], map: "idx_wf_audit_details_gin", type: Gin, where: raw("(details IS NOT NULL)"))
  @@index([tenant_id, step_instance_id], map: "idx_wf_audit_step", where: raw("(step_instance_id IS NOT NULL)"))
  @@index([tenant_id, event_timestamp(sort: Desc), event_type, severity, entity_type, entity_id, actor_user_id, comment, details], map: "idx_wf_audit_timeline")
  @@schema("core")
}

/// Daily hash chain anchors for tamper-evidence verification.
model audit_hash_anchor {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String   @db.Uuid
  anchor_date DateTime @db.Date
  last_hash   String
  event_count Int
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  tenant      Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, anchor_date], map: "audit_hash_anchor_uniq")
  @@index([tenant_id, anchor_date(sort: Desc)], map: "idx_audit_hash_anchor_tenant")
  @@schema("core")
}

/// Async audit ingestion buffer. Worker drains to workflow_audit_event with retries.
/// This table contains check constraints and requires additional setup for migrations.
model audit_outbox {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  event_type   String
  payload      Json
  status       String    @default("pending")
  attempts     Int       @default(0)
  max_attempts Int       @default(5)
  available_at DateTime  @default(now()) @db.Timestamptz(6)
  locked_at    DateTime? @db.Timestamptz(6)
  locked_by    String?
  last_error   String?
  created_at   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([status, available_at], map: "idx_audit_outbox_pick", where: raw("(status = ANY (ARRAY['pending'::text, 'failed'::text]))"))
  @@index([tenant_id, status], map: "idx_audit_outbox_tenant")
  @@index([status, created_at(sort: Desc)], map: "idx_audit_outbox_dead", where: raw("(status = 'dead'::text)"))
  @@schema("core")
}

model audit_archive_marker {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  partition_name  String    @unique
  partition_month DateTime  @unique @db.Date
  ndjson_key      String
  sha256          String
  row_count       BigInt    @default(0)
  archived_at     DateTime  @default(now()) @db.Timestamptz(6)
  archived_by     String
  detached_at     DateTime? @db.Timestamptz(6)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)

  @@index([partition_month], map: "idx_archive_marker_month")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_dlq {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id      String    @db.Uuid
  outbox_id      String    @db.Uuid
  event_type     String
  payload        Json
  last_error     String?
  error_category String?
  attempt_count  Int       @default(0)
  dead_at        DateTime  @default(now()) @db.Timestamptz(6)
  replayed_at    DateTime? @db.Timestamptz(6)
  replayed_by    String?
  replay_count   Int       @default(0)
  correlation_id String?
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  tenant         Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([correlation_id], map: "idx_audit_dlq_correlation", where: raw("(correlation_id IS NOT NULL)"))
  @@index([tenant_id, created_at(sort: Desc)], map: "idx_audit_dlq_tenant")
  @@index([tenant_id, dead_at(sort: Desc)], map: "idx_audit_dlq_unreplayed", where: raw("(replayed_at IS NULL)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_integrity_report {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String    @db.Uuid
  verification_type   String
  start_date          DateTime? @db.Timestamptz(6)
  end_date            DateTime? @db.Timestamptz(6)
  status              String    @default("pending")
  events_checked      Int?      @default(0)
  chain_valid         Boolean?
  anchor_match        Boolean?
  partitions_complete Boolean?
  export_hash_valid   Boolean?
  broken_at_event_id  String?
  broken_at_index     Int?
  error_message       String?
  details             Json?     @default("{}")
  initiated_by        String
  started_at          DateTime? @db.Timestamptz(6)
  completed_at        DateTime? @db.Timestamptz(6)
  created_at          DateTime  @default(now()) @db.Timestamptz(6)

  @@index([tenant_id, created_at(sort: Desc)], map: "idx_integrity_report_tenant_created")
  @@index([tenant_id, status, created_at(sort: Desc)], map: "idx_integrity_report_tenant_status")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_brand_profile {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String       @db.Uuid
  code              String
  name              String
  palette           Json?
  typography        Json?
  spacing_scale     Json?
  direction         String       @default("LTR")
  default_locale    String       @default("en")
  supported_locales String[]
  is_default        Boolean      @default(false)
  metadata          Json?
  created_at        DateTime     @default(now()) @db.Timestamptz(6)
  created_by        String
  updated_at        DateTime?    @db.Timestamptz(6)
  updated_by        String?
  tenant            Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doc_output        doc_output[]

  @@unique([tenant_id, code], map: "idx_doc_brand_profile_tenant_code")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_letterhead {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String       @db.Uuid
  code              String
  name              String
  org_unit_id       String?      @db.Uuid
  logo_storage_key  String?
  header_html       String?
  footer_html       String?
  watermark_text    String?
  watermark_opacity Decimal?     @default(0.15) @db.Decimal(3, 2)
  default_fonts     Json?
  page_margins      Json?
  is_default        Boolean      @default(false)
  metadata          Json?
  created_at        DateTime     @default(now()) @db.Timestamptz(6)
  created_by        String
  updated_at        DateTime?    @db.Timestamptz(6)
  updated_by        String?
  tenant            Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doc_output        doc_output[]

  @@unique([tenant_id, code], map: "idx_doc_letterhead_tenant_code")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_output {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String                @db.Uuid
  template_version_id  String?               @db.Uuid
  letterhead_id        String?               @db.Uuid
  brand_profile_id     String?               @db.Uuid
  entity_name          String
  entity_id            String
  operation            String
  variant              String                @default("default")
  locale               String                @default("en")
  timezone             String                @default("UTC")
  status               String                @default("QUEUED")
  storage_key          String?
  mime_type            String?               @default("application/pdf")
  size_bytes           BigInt?
  checksum             String?
  manifest_json        Json
  input_payload_hash   String?
  replaces_output_id   String?               @db.Uuid
  error_message        String?
  rendered_at          DateTime?             @db.Timestamptz(6)
  delivered_at         DateTime?             @db.Timestamptz(6)
  archived_at          DateTime?             @db.Timestamptz(6)
  revoked_at           DateTime?             @db.Timestamptz(6)
  revoked_by           String?
  revoke_reason        String?
  created_at           DateTime              @default(now()) @db.Timestamptz(6)
  created_by           String
  storage_bucket       String?
  storage_version_id   String?
  manifest_version     Int                   @default(1)
  error_code           String?
  doc_brand_profile    doc_brand_profile?    @relation(fields: [brand_profile_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  doc_letterhead       doc_letterhead?       @relation(fields: [letterhead_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  doc_output           doc_output?           @relation("doc_outputTodoc_output", fields: [replaces_output_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_doc_output     doc_output[]          @relation("doc_outputTodoc_output")
  doc_template_version doc_template_version? @relation(fields: [template_version_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenant               Tenant                @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doc_render_dlq       doc_render_dlq[]
  doc_render_job       doc_render_job[]

  @@unique([tenant_id, template_version_id, entity_name, entity_id, operation, variant, input_payload_hash], map: "idx_doc_output_inflight_idempotency", where: raw("(status = ANY (ARRAY['QUEUED'::text, 'RENDERING'::text]))"))
  @@index([tenant_id, entity_name, entity_id], map: "idx_doc_output_entity")
  @@index([replaces_output_id], map: "idx_doc_output_replaces", where: raw("(replaces_output_id IS NOT NULL)"))
  @@index([tenant_id, status], map: "idx_doc_output_status")
  @@index([template_version_id], map: "idx_doc_output_template_version")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_render_dlq {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id      String          @db.Uuid
  output_id      String          @db.Uuid
  render_job_id  String?         @db.Uuid
  error_code     String
  error_detail   String?
  error_category String
  attempt_count  Int             @default(0)
  payload        Json
  replayed_at    DateTime?       @db.Timestamptz(6)
  replayed_by    String?
  replay_count   Int             @default(0)
  dead_at        DateTime        @default(now()) @db.Timestamptz(6)
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  doc_output     doc_output      @relation(fields: [output_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  doc_render_job doc_render_job? @relation(fields: [render_job_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenant         Tenant          @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([output_id], map: "idx_doc_render_dlq_output")
  @@index([tenant_id], map: "idx_doc_render_dlq_unreplayed", where: raw("(replayed_at IS NULL)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_render_job {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  output_id      String           @db.Uuid
  tenant_id      String           @db.Uuid
  job_queue_id   String?
  status         String           @default("PENDING")
  attempts       Int              @default(0)
  max_attempts   Int              @default(3)
  error_code     String?
  error_detail   String?
  trace_id       String?
  started_at     DateTime?        @db.Timestamptz(6)
  completed_at   DateTime?        @db.Timestamptz(6)
  duration_ms    Int?
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  doc_render_dlq doc_render_dlq[]
  doc_output     doc_output       @relation(fields: [output_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant         Tenant           @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([output_id], map: "idx_doc_render_job_output")
  @@index([tenant_id, status], map: "idx_doc_render_job_status")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_template {
  id                                                                         String                 @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                                                  String                 @db.Uuid
  code                                                                       String
  name                                                                       String
  kind                                                                       String
  engine                                                                     String                 @default("HANDLEBARS")
  status                                                                     String                 @default("DRAFT")
  current_version_id                                                         String?                @db.Uuid
  metadata                                                                   Json?
  created_at                                                                 DateTime               @default(now()) @db.Timestamptz(6)
  created_by                                                                 String
  updated_at                                                                 DateTime?              @db.Timestamptz(6)
  updated_by                                                                 String?
  supports_rtl                                                               Boolean                @default(false)
  requires_letterhead                                                        Boolean                @default(false)
  allowed_operations                                                         String[]
  supported_locales                                                          String[]
  tenant                                                                     Tenant                 @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doc_template_version_doc_template_current_version_idTodoc_template_version doc_template_version?  @relation("doc_template_current_version_idTodoc_template_version", fields: [current_version_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_doc_template_current_version")
  doc_template_binding                                                       doc_template_binding[]
  doc_template_version_doc_template_version_template_idTodoc_template        doc_template_version[] @relation("doc_template_version_template_idTodoc_template")

  @@unique([tenant_id, code], map: "idx_doc_template_tenant_code")
  @@index([tenant_id, status], map: "idx_doc_template_tenant_status")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_template_binding {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String       @db.Uuid
  template_id  String       @db.Uuid
  entity_name  String
  operation    String
  variant      String       @default("default")
  priority     Int          @default(0)
  active       Boolean      @default(true)
  created_at   DateTime     @default(now()) @db.Timestamptz(6)
  created_by   String
  doc_template doc_template @relation(fields: [template_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant       Tenant       @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_name, operation, variant], map: "idx_doc_template_binding_unique")
  @@index([template_id], map: "idx_doc_template_binding_template")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model doc_template_version {
  id                                                                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                                          String         @db.Uuid
  template_id                                                        String         @db.Uuid
  version                                                            Int
  content_html                                                       String?
  content_json                                                       Json?
  header_html                                                        String?
  footer_html                                                        String?
  styles_css                                                         String?
  variables_schema                                                   Json?
  assets_manifest                                                    Json?
  checksum                                                           String
  published_at                                                       DateTime?      @db.Timestamptz(6)
  published_by                                                       String?
  effective_from                                                     DateTime?      @db.Timestamptz(6)
  effective_to                                                       DateTime?      @db.Timestamptz(6)
  created_at                                                         DateTime       @default(now()) @db.Timestamptz(6)
  created_by                                                         String
  doc_output                                                         doc_output[]
  doc_template_doc_template_current_version_idTodoc_template_version doc_template[] @relation("doc_template_current_version_idTodoc_template_version")
  doc_template_doc_template_version_template_idTodoc_template        doc_template   @relation("doc_template_version_template_idTodoc_template", fields: [template_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                                                             Tenant         @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([template_id, version], map: "idx_doc_template_version_tpl_ver")
  @@index([tenant_id], map: "idx_doc_template_version_tenant")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model notification_digest_staging {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  principal_id String    @db.Uuid
  channel      String
  frequency    String
  message_id   String    @db.Uuid
  event_type   String
  subject      String?
  payload      Json
  template_key String
  priority     String    @default("normal")
  metadata     Json?
  staged_at    DateTime  @default(now()) @db.Timestamptz(6)
  delivered_at DateTime? @db.Timestamptz(6)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "notification_digest_staging_tenant_fkey")

  @@index([frequency, staged_at], map: "idx_digest_staging_frequency", where: raw("(delivered_at IS NULL)"))
  @@index([tenant_id, principal_id, channel, frequency], map: "idx_digest_staging_pending", where: raw("(delivered_at IS NULL)"))
  @@schema("core")
}

model notification_dlq {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id      String    @db.Uuid
  delivery_id    String    @db.Uuid
  message_id     String    @db.Uuid
  channel        String
  provider_code  String
  recipient_id   String?   @db.Uuid
  recipient_addr String
  last_error     String?
  error_category String?
  attempt_count  Int       @default(0)
  payload        Json
  metadata       Json?
  dead_at        DateTime  @default(now()) @db.Timestamptz(6)
  replayed_at    DateTime? @db.Timestamptz(6)
  replayed_by    String?
  replay_count   Int       @default(0)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  tenant         Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "notification_dlq_tenant_fkey")

  @@index([tenant_id, dead_at(sort: Desc)], map: "idx_notification_dlq_tenant")
  @@index([tenant_id], map: "idx_notification_dlq_unreplayed", where: raw("(replayed_at IS NULL)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model core_notification_preference {
  id          String    @id(map: "core_notification_preference_pkey") @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id   String    @db.Uuid
  scope       String
  scope_id    String    @db.Uuid
  event_code  String
  channel     String
  is_enabled  Boolean   @default(true)
  frequency   String    @default("immediate")
  quiet_hours Json?
  metadata    Json?
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_by  String
  updated_at  DateTime? @db.Timestamptz(6)
  updated_by  String?
  tenant      Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "core_notification_preference_tenant_fkey")

  @@unique([tenant_id, scope, scope_id, event_code, channel], map: "core_notification_preference_scope_uniq")
  @@index([tenant_id, scope_id, event_code, channel], map: "idx_core_notification_preference_lookup")
  @@map("notification_preference")
  @@schema("core")
}

model whatsapp_consent {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                 String    @db.Uuid
  phone_number              String
  principal_id              String?   @db.Uuid
  opted_in                  Boolean   @default(false)
  opted_in_at               DateTime? @db.Timestamptz(6)
  opted_out_at              DateTime? @db.Timestamptz(6)
  opt_in_method             String?
  conversation_window_start DateTime? @db.Timestamptz(6)
  conversation_window_end   DateTime? @db.Timestamptz(6)
  metadata                  Json?
  created_at                DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                DateTime? @db.Timestamptz(6)
  tenant                    Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "whatsapp_consent_tenant_fkey")

  @@unique([tenant_id, phone_number], map: "whatsapp_consent_tenant_phone_uniq")
  @@index([principal_id], map: "idx_whatsapp_consent_principal", where: raw("(principal_id IS NOT NULL)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model customer {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String    @db.Uuid
  code               String
  name               String
  display_name       String?
  customer_type      String    @default("individual")
  status             String    @default("active")
  tax_id             String?
  industry_code      String?
  primary_contact_id String?   @db.Uuid
  primary_address_id String?   @db.Uuid
  metadata           Json?
  tags               String[]
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  created_by         String
  updated_at         DateTime? @db.Timestamptz(6)
  updated_by         String?
  tenant             Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "customer_tenant_code_uniq")
  @@index([tenant_id, name], map: "idx_customer_name")
  @@index([tenant_id, status], map: "idx_customer_status")
  @@index([tags], map: "idx_customer_tags", type: Gin)
  @@index([tenant_id], map: "idx_customer_tenant")
  @@schema("ent")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model employee {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String               @db.Uuid
  principal_id        String?              @db.Uuid
  employee_number     String
  first_name          String
  last_name           String
  display_name        String?
  email               String?
  phone               String?
  status              String               @default("active")
  employment_type     String               @default("full_time")
  department          String?
  title               String?
  manager_id          String?              @db.Uuid
  ou_id               String?              @db.Uuid
  hire_date           DateTime?            @db.Date
  termination_date    DateTime?            @db.Date
  metadata            Json?
  tags                String[]
  created_at          DateTime             @default(now()) @db.Timestamptz(6)
  created_by          String
  updated_at          DateTime?            @db.Timestamptz(6)
  updated_by          String?
  employee            employee?            @relation("employeeToemployee", fields: [manager_id], references: [id], onUpdate: NoAction)
  other_employee      employee[]           @relation("employeeToemployee")
  organizational_unit organizational_unit? @relation(fields: [ou_id], references: [id], onUpdate: NoAction)
  principal           Principal?           @relation(fields: [principal_id], references: [id], onUpdate: NoAction)
  tenant              Tenant               @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, employee_number], map: "employee_tenant_number_uniq")
  @@index([tenant_id, department], map: "idx_employee_department")
  @@index([manager_id], map: "idx_employee_manager")
  @@index([principal_id], map: "idx_employee_principal")
  @@index([tenant_id, status], map: "idx_employee_status")
  @@index([tenant_id], map: "idx_employee_tenant")
  @@schema("ent")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_relationship {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String    @db.Uuid
  relationship_type String
  entity_a_type     String
  entity_a_id       String    @db.Uuid
  entity_b_type     String
  entity_b_id       String    @db.Uuid
  is_bidirectional  Boolean   @default(false)
  status            String    @default("active")
  effective_from    DateTime? @db.Timestamptz(6)
  effective_until   DateTime? @db.Timestamptz(6)
  metadata          Json?
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  created_by        String
  updated_at        DateTime? @db.Timestamptz(6)
  updated_by        String?
  tenant            Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_a_type, entity_a_id], map: "idx_entity_relationship_a")
  @@index([tenant_id, entity_b_type, entity_b_id], map: "idx_entity_relationship_b")
  @@index([tenant_id, relationship_type], map: "idx_entity_relationship_type")
  @@schema("ent")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model product {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id        String            @db.Uuid
  code             String
  sku              String?
  name             String
  description      String?
  category_id      String?           @db.Uuid
  status           String            @default("active")
  product_type     String            @default("physical")
  unit_of_measure  String?
  base_price       Decimal?          @db.Decimal(18, 4)
  currency_code    String?
  is_taxable       Boolean           @default(true)
  tax_code         String?
  metadata         Json?
  tags             String[]
  created_at       DateTime          @default(now()) @db.Timestamptz(6)
  created_by       String
  updated_at       DateTime?         @db.Timestamptz(6)
  updated_by       String?
  product_category product_category? @relation(fields: [category_id], references: [id], onUpdate: NoAction)
  tenant           Tenant            @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "product_tenant_code_uniq")
  @@index([category_id], map: "idx_product_category")
  @@index([tenant_id, sku], map: "idx_product_sku")
  @@index([tenant_id, status], map: "idx_product_status")
  @@index([tags], map: "idx_product_tags", type: Gin)
  @@index([tenant_id], map: "idx_product_tenant")
  @@schema("ent")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model product_category {
  id                     String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id              String             @db.Uuid
  code                   String
  name                   String
  description            String?
  parent_id              String?            @db.Uuid
  sort_order             Int?
  is_active              Boolean            @default(true)
  metadata               Json?
  created_at             DateTime           @default(now()) @db.Timestamptz(6)
  created_by             String
  updated_at             DateTime?          @db.Timestamptz(6)
  updated_by             String?
  product                product[]
  product_category       product_category?  @relation("product_categoryToproduct_category", fields: [parent_id], references: [id], onUpdate: NoAction)
  other_product_category product_category[] @relation("product_categoryToproduct_category")
  tenant                 Tenant             @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "product_category_tenant_code_uniq")
  @@index([parent_id], map: "idx_product_category_parent")
  @@index([tenant_id], map: "idx_product_category_tenant")
  @@schema("ent")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model supplier {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String    @db.Uuid
  code               String
  name               String
  display_name       String?
  supplier_type      String    @default("vendor")
  status             String    @default("active")
  tax_id             String?
  industry_code      String?
  primary_contact_id String?   @db.Uuid
  primary_address_id String?   @db.Uuid
  payment_terms      String?
  currency_code      String?
  metadata           Json?
  tags               String[]
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  created_by         String
  updated_at         DateTime? @db.Timestamptz(6)
  updated_by         String?
  tenant             Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, code], map: "supplier_tenant_code_uniq")
  @@index([tenant_id, name], map: "idx_supplier_name")
  @@index([tenant_id, status], map: "idx_supplier_status")
  @@index([tenant_id], map: "idx_supplier_tenant")
  @@schema("ent")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model audit_policy {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id      String?  @db.Uuid
  event_category String
  disposition    String   @default("required")
  sample_rate    Decimal  @default(1.000) @db.Decimal(4, 3)
  enabled        Boolean  @default(true)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @default(now()) @db.Timestamptz(6)
  tenant         Tenant?  @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, event_category], map: "audit_policy_uniq")
  @@index([tenant_id, event_category], map: "idx_audit_policy_tenant")
  @@schema("meta")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_mention {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String    @db.Uuid
  comment_type      String
  comment_id        String    @db.Uuid
  mentioned_user_id String    @db.Uuid
  mention_text      String
  position          Int
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  principal         Principal @relation(fields: [mentioned_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([comment_type, comment_id], map: "idx_comment_mention_comment")
  @@index([mentioned_user_id, created_at(sort: Desc)], map: "idx_comment_mention_user")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model entity_comment {
  id                   String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id            String           @db.Uuid
  entity_type          String
  entity_id            String           @db.Uuid
  commenter_id         String           @db.Uuid
  comment_text         String
  parent_comment_id    String?          @db.Uuid
  thread_depth         Int              @default(0)
  deleted_at           DateTime?        @db.Timestamptz(6)
  deleted_by           String?
  created_at           DateTime         @default(now()) @db.Timestamptz(6)
  created_by           String
  updated_at           DateTime?        @db.Timestamptz(6)
  updated_by           String?
  visibility           String           @default("public")
  archived_at          DateTime?        @db.Timestamptz(6)
  archived_by          String?
  retention_until      DateTime?        @db.Timestamptz(6)
  retention_policy_id  String?          @db.Uuid
  comment_draft        comment_draft[]
  principal            Principal        @relation(fields: [commenter_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  entity_comment       entity_comment?  @relation("entity_commentToentity_comment", fields: [parent_comment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  other_entity_comment entity_comment[] @relation("entity_commentToentity_comment")
  tenant               Tenant           @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([commenter_id, created_at(sort: Desc)], map: "idx_entity_comment_commenter", where: raw("(deleted_at IS NULL)"))
  @@index([tenant_id, entity_type, entity_id, created_at(sort: Desc)], map: "idx_entity_comment_entity", where: raw("(deleted_at IS NULL)"))
  @@index([parent_comment_id, created_at], map: "idx_entity_comment_parent", where: raw("((parent_comment_id IS NOT NULL) AND (deleted_at IS NULL))"))
  @@index([tenant_id, entity_type, entity_id, visibility, created_at(sort: Desc)], map: "idx_entity_comment_visibility", where: raw("(deleted_at IS NULL)"))
  @@index([tenant_id, archived_at], map: "idx_entity_comment_archived", where: raw("(archived_at IS NOT NULL)"))
  @@index([tenant_id, retention_until], map: "idx_entity_comment_retention", where: raw("((retention_until IS NOT NULL) AND (deleted_at IS NULL))"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model lifecycle_timer_schedule {
  id                     String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id              String                  @db.Uuid
  entity_name            String
  entity_id              String
  lifecycle_id           String                  @db.Uuid
  state_id               String                  @db.Uuid
  timer_type             String
  transition_id          String?                 @db.Uuid
  scheduled_at           DateTime                @default(now()) @db.Timestamptz(6)
  fire_at                DateTime                @db.Timestamptz(6)
  job_id                 String
  policy_id              String?                 @db.Uuid
  policy_snapshot        Json
  status                 String                  @default("scheduled")
  created_at             DateTime                @default(now()) @db.Timestamptz(6)
  created_by             String
  lifecycle              meta_lifecycle          @relation(fields: [lifecycle_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_timer_policy lifecycle_timer_policy? @relation(fields: [policy_id], references: [id], onUpdate: NoAction)
  lifecycle_state        lifecycle_state         @relation(fields: [state_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                 Tenant                  @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  lifecycle_transition   lifecycle_transition?   @relation(fields: [transition_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, entity_name, entity_id], map: "idx_lifecycle_timer_schedule_entity")
  @@index([tenant_id, status, fire_at], map: "idx_lifecycle_timer_schedule_fire_at")
  @@index([job_id], map: "idx_lifecycle_timer_schedule_job_id")
  @@index([tenant_id, state_id, status], map: "idx_lifecycle_timer_schedule_state")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_draft {
  id                String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id         String          @db.Uuid
  user_id           String          @db.Uuid
  entity_type       String
  entity_id         String          @db.Uuid
  parent_comment_id String?         @db.Uuid
  draft_text        String
  visibility        String          @default("public")
  created_at        DateTime        @default(now()) @db.Timestamptz(6)
  updated_at        DateTime        @default(now()) @db.Timestamptz(6)
  entity_comment    entity_comment? @relation(fields: [parent_comment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant            Tenant          @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal         Principal       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, user_id, entity_type, entity_id, parent_comment_id], map: "comment_draft_unique")
  @@index([tenant_id, entity_type, entity_id], map: "idx_comment_draft_entity")
  @@index([tenant_id, user_id, updated_at(sort: Desc)], map: "idx_comment_draft_user")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_reaction {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String    @db.Uuid
  comment_type  String
  comment_id    String    @db.Uuid
  user_id       String    @db.Uuid
  reaction_type String
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  tenant        Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal     Principal @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, comment_type, comment_id, user_id, reaction_type], map: "comment_reaction_unique")
  @@index([tenant_id, comment_type, comment_id], map: "idx_comment_reaction_comment")
  @@index([tenant_id, user_id, created_at(sort: Desc)], map: "idx_comment_reaction_user")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_read_status {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id    String    @db.Uuid
  comment_type String
  comment_id   String    @db.Uuid
  user_id      String    @db.Uuid
  read_at      DateTime  @default(now()) @db.Timestamptz(6)
  tenant       Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal    Principal @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, comment_type, comment_id, user_id], map: "comment_read_status_unique")
  @@index([tenant_id, comment_type, comment_id], map: "idx_comment_read_status_comment")
  @@index([tenant_id, user_id, read_at(sort: Desc)], map: "idx_comment_read_status_user")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_analytics_daily {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id          String   @db.Uuid
  date               DateTime @db.Date
  entity_type        String?
  total_comments     Int      @default(0)
  total_replies      Int      @default(0)
  unique_commenters  Int      @default(0)
  total_reactions    Int      @default(0)
  total_flags        Int      @default(0)
  avg_comment_length Int?
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  updated_at         DateTime @default(now()) @db.Timestamptz(6)
  tenant             Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, date, entity_type], map: "comment_analytics_daily_unique")
  @@index([tenant_id, date(sort: Desc)], map: "idx_comment_analytics_daily_date")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_flag {
  id                                                String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                         String     @db.Uuid
  comment_type                                      String
  comment_id                                        String     @db.Uuid
  flagger_user_id                                   String     @db.Uuid
  flag_reason                                       String
  flag_details                                      String?
  status                                            String     @default("pending")
  reviewed_by                                       String?    @db.Uuid
  reviewed_at                                       DateTime?  @db.Timestamptz(6)
  resolution                                        String?
  created_at                                        DateTime   @default(now()) @db.Timestamptz(6)
  principal_comment_flag_flagger_user_idToprincipal Principal  @relation("comment_flag_flagger_user_idToprincipal", fields: [flagger_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal_comment_flag_reviewed_byToprincipal     Principal? @relation("comment_flag_reviewed_byToprincipal", fields: [reviewed_by], references: [id], onUpdate: NoAction)
  tenant                                            Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, comment_type, comment_id, flagger_user_id], map: "comment_flag_unique")
  @@index([tenant_id, comment_type, comment_id, status], map: "idx_comment_flag_comment")
  @@index([tenant_id, status, created_at(sort: Desc)], map: "idx_comment_flag_pending", where: raw("(status = 'pending'::text)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_moderation_status {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id       String     @db.Uuid
  comment_type    String
  comment_id      String     @db.Uuid
  is_hidden       Boolean    @default(false)
  hidden_reason   String?
  hidden_at       DateTime?  @db.Timestamptz(6)
  hidden_by       String?    @db.Uuid
  flag_count      Int        @default(0)
  last_flagged_at DateTime?  @db.Timestamptz(6)
  created_at      DateTime   @default(now()) @db.Timestamptz(6)
  updated_at      DateTime   @default(now()) @db.Timestamptz(6)
  principal       Principal? @relation(fields: [hidden_by], references: [id], onUpdate: NoAction)
  tenant          Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, comment_type, comment_id], map: "comment_moderation_unique")
  @@index([tenant_id, flag_count(sort: Desc), last_flagged_at(sort: Desc)], map: "idx_comment_moderation_flags", where: raw("(flag_count > 0)"))
  @@index([tenant_id, is_hidden, updated_at(sort: Desc)], map: "idx_comment_moderation_hidden", where: raw("(is_hidden = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_response_history {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id             String    @db.Uuid
  entity_type           String
  entity_id             String    @db.Uuid
  comment_id            String    @db.Uuid
  parent_comment_id     String?   @db.Uuid
  commenter_id          String    @db.Uuid
  response_time_seconds Int?
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  principal             Principal @relation(fields: [commenter_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tenant                Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, comment_id], map: "comment_response_history_unique")
  @@index([tenant_id, entity_type, entity_id, created_at(sort: Desc)], map: "idx_comment_response_history_entity")
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_retention_log {
  id                       String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                String                    @db.Uuid
  comment_type             String
  comment_id               String                    @db.Uuid
  action                   String
  policy_id                String?                   @db.Uuid
  executed_by              String
  executed_at              DateTime                  @default(now()) @db.Timestamptz(6)
  comment_snapshot         Json?
  comment_retention_policy comment_retention_policy? @relation(fields: [policy_id], references: [id], onUpdate: NoAction)
  tenant                   Tenant                    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, comment_type, comment_id, executed_at(sort: Desc)], map: "idx_comment_retention_log_comment")
  @@index([tenant_id, policy_id, executed_at(sort: Desc)], map: "idx_comment_retention_log_policy", where: raw("(policy_id IS NOT NULL)"))
  @@schema("core")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_retention_policy {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id             String                  @db.Uuid
  policy_name           String
  entity_type           String?
  retention_days        Int
  action                String                  @default("archive")
  enabled               Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @db.Timestamptz(6)
  comment_retention_log comment_retention_log[]
  tenant                Tenant                  @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tenant_id, enabled], map: "idx_comment_retention_policy_active", where: raw("(enabled = true)"))
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_sla_config {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String   @db.Uuid
  entity_type         String
  sla_target_seconds  Int
  enabled             Boolean  @default(true)
  business_hours_only Boolean  @default(false)
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @default(now()) @db.Timestamptz(6)
  tenant              Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_type], map: "comment_sla_config_unique")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_sla_metrics {
  id                                                         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                                                  String     @db.Uuid
  entity_type                                                String
  entity_id                                                  String     @db.Uuid
  first_comment_at                                           DateTime   @db.Timestamptz(6)
  first_comment_by                                           String     @db.Uuid
  first_response_at                                          DateTime?  @db.Timestamptz(6)
  first_response_by                                          String?    @db.Uuid
  first_response_time_seconds                                Int?
  total_comments                                             Int        @default(1)
  total_responses                                            Int        @default(0)
  avg_response_time_seconds                                  Int?
  max_response_time_seconds                                  Int?
  sla_target_seconds                                         Int?
  is_sla_breached                                            Boolean    @default(false)
  created_at                                                 DateTime   @default(now()) @db.Timestamptz(6)
  updated_at                                                 DateTime   @default(now()) @db.Timestamptz(6)
  principal_comment_sla_metrics_first_comment_byToprincipal  Principal  @relation("comment_sla_metrics_first_comment_byToprincipal", fields: [first_comment_by], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal_comment_sla_metrics_first_response_byToprincipal Principal? @relation("comment_sla_metrics_first_response_byToprincipal", fields: [first_response_by], references: [id], onUpdate: NoAction)
  tenant                                                     Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_type, entity_id], map: "comment_sla_metrics_unique")
  @@index([tenant_id, is_sla_breached, first_comment_at(sort: Desc)], map: "idx_comment_sla_breached", where: raw("(is_sla_breached = true)"))
  @@index([tenant_id, first_comment_at(sort: Desc)], map: "idx_comment_sla_pending", where: raw("(first_response_at IS NULL)"))
  @@index([tenant_id, first_response_time_seconds], map: "idx_comment_sla_response_time")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model comment_thread_analytics {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id           String   @db.Uuid
  entity_type         String
  entity_id           String   @db.Uuid
  total_comments      Int      @default(0)
  unique_participants Int      @default(0)
  total_reactions     Int      @default(0)
  thread_depth        Int      @default(0)
  first_comment_at    DateTime @db.Timestamptz(6)
  last_comment_at     DateTime @db.Timestamptz(6)
  is_active           Boolean  @default(true)
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @default(now()) @db.Timestamptz(6)
  tenant              Tenant   @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, entity_type, entity_id], map: "comment_thread_analytics_unique")
  @@index([tenant_id, is_active, total_comments(sort: Desc)], map: "idx_comment_thread_analytics_active", where: raw("(is_active = true)"))
  @@index([tenant_id, last_comment_at(sort: Desc)], map: "idx_comment_thread_analytics_recent")
  @@schema("core")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an index with non-default null sort order and requires additional setup for migrations. Visit https://pris.ly/d/default-index-null-ordering for more info.
model comment_user_engagement {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id                 String    @db.Uuid
  user_id                   String    @db.Uuid
  period_start              DateTime  @db.Date
  period_end                DateTime  @db.Date
  total_comments            Int       @default(0)
  total_replies             Int       @default(0)
  total_reactions_given     Int       @default(0)
  total_reactions_received  Int       @default(0)
  total_mentions_received   Int       @default(0)
  avg_response_time_seconds Int?
  engagement_score          Int?
  created_at                DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                DateTime  @default(now()) @db.Timestamptz(6)
  tenant                    Tenant    @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  principal                 Principal @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([tenant_id, user_id, period_start, period_end], map: "comment_user_engagement_unique")
  @@index([tenant_id, engagement_score(sort: Desc), period_start(sort: Desc)], map: "idx_comment_user_engagement_score")
  @@schema("core")
}

// ============================================================================
// Content Management Enhancement Models
// ============================================================================

model entity_document_link {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String     @db.Uuid
  entity_type   String
  entity_id     String     @db.Uuid
  attachment_id String     @db.Uuid
  link_kind     String     @default("related")
  display_order Int        @default(0)
  metadata      Json?
  created_at    DateTime   @default(now()) @db.Timestamptz(6)
  created_by    String

  tenant        Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  attachment    attachment @relation(fields: [attachment_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, entity_type, entity_id, attachment_id])
  @@index([tenant_id, entity_type, entity_id, link_kind])
  @@schema("core")
}

model document_acl {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String     @db.Uuid
  attachment_id String     @db.Uuid
  principal_id  String?    @db.Uuid
  role_id       String?    @db.Uuid
  permission    String
  granted       Boolean    @default(true)
  granted_by    String
  granted_at    DateTime   @default(now()) @db.Timestamptz(6)
  expires_at    DateTime?  @db.Timestamptz(6)

  tenant        Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  attachment    attachment @relation(fields: [attachment_id], references: [id], onDelete: Cascade)

  @@index([attachment_id, permission])
  @@schema("core")
}

model attachment_access_log {
  id            BigInt     @id @default(autoincrement())
  tenant_id     String     @db.Uuid
  attachment_id String     @db.Uuid
  actor_id      String
  action        String
  ip_address    String?
  user_agent    String?
  accessed_at   DateTime   @default(now()) @db.Timestamptz(6)

  tenant        Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  attachment    attachment @relation(fields: [attachment_id], references: [id])

  @@index([tenant_id, accessed_at(sort: Desc)], map: "idx_access_log_tenant_time")
  @@index([attachment_id, accessed_at(sort: Desc)], map: "idx_access_log_attachment")
  @@index([tenant_id, actor_id, accessed_at(sort: Desc)], map: "idx_access_log_actor")
  @@schema("core")
}

model attachment_comment {
  id            String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String              @db.Uuid
  attachment_id String              @db.Uuid
  parent_id     String?             @db.Uuid
  author_id     String
  content       String
  mentions      Json?
  edited_at     DateTime?           @db.Timestamptz(6)
  edited_by     String?
  deleted_at    DateTime?           @db.Timestamptz(6)
  deleted_by    String?
  created_at    DateTime            @default(now()) @db.Timestamptz(6)
  updated_at    DateTime            @default(now()) @db.Timestamptz(6)

  tenant        Tenant              @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  attachment    attachment          @relation(fields: [attachment_id], references: [id], onDelete: Cascade)
  parent        attachment_comment? @relation("CommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies       attachment_comment[] @relation("CommentReplies")

  @@index([tenant_id, attachment_id, created_at(sort: Desc)], where: raw("deleted_at IS NULL"), map: "idx_comment_attachment")
  @@index([parent_id, created_at], where: raw("parent_id IS NOT NULL AND deleted_at IS NULL"), map: "idx_comment_parent")
  @@index([tenant_id, author_id, created_at(sort: Desc)], where: raw("deleted_at IS NULL"), map: "idx_comment_author")
  @@schema("core")
}

model multipart_upload {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenant_id     String     @db.Uuid
  attachment_id String     @db.Uuid
  s3_upload_id  String     @unique
  total_parts   Int
  completed_parts Int      @default(0)
  part_etags    Json?
  status        String
  initiated_at  DateTime   @default(now()) @db.Timestamptz(6)
  completed_at  DateTime?  @db.Timestamptz(6)
  expires_at    DateTime   @db.Timestamptz(6)

  tenant        Tenant     @relation(fields: [tenant_id], references: [id], onDelete: Cascade)
  attachment    attachment @relation(fields: [attachment_id], references: [id], onDelete: Cascade)

  @@index([attachment_id])
  @@index([tenant_id, status, expires_at], where: raw("status IN ('initiated', 'uploading')"), map: "idx_multipart_status")
  @@schema("core")
}
