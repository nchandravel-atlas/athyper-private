# ========================================================
# Athyper Golden pg_hba.conf
# Single Server A
# Postgres: 127.0.0.1 only
# Access: ONLY via localhost (PgBouncer on host network)
# Auth: SCRAM
# ========================================================

# 1) Keep postgres admin via unix socket
local   all             postgres                                 peer

# 2) Local unix socket for services on the host (optional)
#    If everything goes through PgBouncer, you can keep this,
#    or restrict it further to postgres only.
local   all             all                                      peer

# 3) Allow ONLY localhost TCP (PgBouncer -> Postgres) and only with PGBouncer user
host    all   pgbouncer_auth_user     127.0.0.1/32   scram-sha-256
host    all   pgbouncer_auth_user     ::1/128        scram-sha-256

# 3b) Allow backend DB users that PgBouncer will connect as
host    all   athyper_user            127.0.0.1/32   scram-sha-256
host    all   athyper_user            ::1/128        scram-sha-256

# 3c) Reject any other localhost TCP (PgBouncer -> Postgres)
host    all   all                     127.0.0.1/32           reject
host    all   all                     ::1/128                reject

# 4) Explicit deny everything else (defense-in-depth)
host    all   all                     0.0.0.0/0              reject
host    all   all                     ::0/0                  reject
