; PgBouncer configuration for Athyper (transaction mode)
; This configuration ensures tenant isolation via search_path + session stickiness

; ============================================================================
; Databases section
; ============================================================================
[databases]

; Main Athyper database via PgBouncer
; In production, point this to your actual PgBouncer port (typically 6432)
athyper = host=postgres.local port=5432 dbname=athyper user=athyper

; Optional: Admin database for maintenance
athyper_admin = host=postgres.local port=5432 dbname=athyper user=postgres


; ============================================================================
; PgBouncer Settings section
; ============================================================================
[pgbouncer]

; Pool mode: transaction
; - Each client connection is mapped to a backend connection for the lifetime of a SINGLE transaction
; - When transaction ends (COMMIT/ROLLBACK), connection returns to the pool
; - Session variables (e.g., search_path) set within a transaction survive for that transaction
; - Critical for tenant isolation: SET search_path = 'public,tenant_schema' persists across queries in same txn
pool_mode = transaction

; Maximum number of client connections PgBouncer accepts
; Adjust based on expected concurrent requests
max_client_conn = 1000

; Default pool size per database
; Balance between connection overhead and latency
; Typical: 25-50 for most workloads
default_pool_size = 25

; Minimum pool size (connections to maintain even if idle)
min_pool_size = 5

; Maximum pool size (per database)
max_db_connections = 100

; Connection timeout before PgBouncer terminates idle client
client_idle_timeout = 600

; Connection timeout for backend connections
server_idle_timeout = 600

; Maximum time to wait for a free server connection
queue_mode = LIFO

; Query timeout (0 = no timeout)
query_timeout = 0

; Transaction timeout (0 = no timeout)
; Set higher if you have long-running transactions
transaction_timeout = 0

; Idle transaction timeout
; Force-disconnect idle transactions after this time
idle_in_transaction_session_timeout = 600

; Log settings
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

; Verbosity: trace, debug, info, warning, error
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_sessions = 0

; Admin console
admin_users = postgres
stats_users = postgres

; Listen configuration
listen_port = 6432
listen_addr = *

; Server-side SSL (if backend uses SSL)
server_tls_sslmode = prefer
server_tls_protocols = tlsv1.2,tlsv1.3

; Client-side SSL (if clients use SSL)
client_tls_sslmode = disable

; DNS cache time (seconds)
dns_zone_check_period = 0
dns_nxdomain_ttl = 15

; Application-name tracking
application_name_add_host = 0


; ============================================================================
; User credentials section (prefer pgpass for production)
; ============================================================================
[users]

; Credentials for athyper service user
; In production: use .pgpass or environment variables instead
athyper = password


; ============================================================================
; Performance Tuning for Tenant Isolation
; ============================================================================

; To verify tenant isolation works correctly:
; 1. Connect to PgBouncer: psql -h localhost -p 6432 -U athyper -d athyper
; 2. Run: SET search_path = 'public,tenant_schema';
; 3. Run: SELECT * FROM users;  -- Should only see tenant_schema.users
; 4. Check SHOW search_path; -- Should show: public, tenant_schema
; 5. Commit/close connection
; 6. Reconnect and verify search_path is reset (connection reused from pool)

; Connection lifecycle with transaction mode:
; Client connects -> Gets backend connection from pool
;   -> Client: SET search_path = 'public,tenant_schema'
;   -> Client: SELECT/INSERT/UPDATE queries (all use tenant schema)
;   -> Client: COMMIT (or implicit commit)
; Connection returns to pool (search_path resets to default on next client)

; Recommended monitoring:
; - Watch pool utilization: SHOW POOLS;
; - Monitor wait queues: SHOW CLIENTS;
; - Track errors: tail /var/log/pgbouncer/pgbouncer.log
; - Alert on max_client_conn approaching limit
