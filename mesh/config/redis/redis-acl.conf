# =============================================================================
# athyper Mesh -- Redis ACL Configuration (Reference)
# =============================================================================
#
# SECURITY RATIONALE
# ------------------
# Redis is used by the athyper runtime exclusively as a session/cache store.
# The key namespaces are:
#
#   sess:<tenantId>:<sid>             - BFF session blobs (RedisSessionStore)
#   user_sessions:<tenantId>:<userId> - SET of active sids per user (for mass revocation)
#   pkce_state:<state>                - PKCE verifier storage during auth code flow
#   jwks:<realmKey>                   - Cached JWKS key sets from Keycloak
#
# By restricting the application user to ONLY these key patterns we prevent:
#   1. Accidental key pollution from application bugs.
#   2. Lateral movement if app credentials are compromised â€” the attacker
#      cannot issue CONFIG, DEBUG, CLUSTER, or SCRIPT commands.
#   3. Data exfiltration of keys outside the session/auth namespace.
#
# IMPORTANT
# ---------
# This file is a REFERENCE configuration. In production:
#   - Passwords MUST be injected from a secrets manager (Vault, AWS SM, etc.).
#   - Replace the placeholder hashes below with real SHA-256 password hashes
#     generated via:  echo -n 'yourpassword' | sha256sum
#   - Or use cleartext passwords with >apassword syntax during development ONLY.
#   - Mount this file read-only into the Redis container.
#   - Rotate credentials on a regular schedule (see docs/runbooks/auth-operations.md).
#
# GENERATING PASSWORD HASHES
# --------------------------
# Redis ACL accepts SHA-256 hex-encoded hashes prefixed with '#':
#
#   printf '%s' 'my-secret-password' | sha256sum | awk '{print "#" $1}'
#
# =============================================================================


# -----------------------------------------------------------------------------
# 1. DEFAULT USER -- disabled
# -----------------------------------------------------------------------------
# Disable the implicit "default" user to prevent unauthenticated access.
# All connections MUST authenticate with an explicit username and password.

user default off


# -----------------------------------------------------------------------------
# 2. APP USER -- least-privilege for the athyper runtime
# -----------------------------------------------------------------------------
# Allowed commands:
#   - String ops:   GET, SET, DEL, TTL, PTTL, EXPIRE, PEXPIRE, EXISTS, TYPE
#   - Set ops:      SADD, SREM, SMEMBERS, SCARD, SISMEMBER
#   - Key mgmt:     KEYS (restricted by pattern), SCAN, UNLINK
#   - Connection:   AUTH, PING, QUIT, RESET, CLIENT SETNAME, CLIENT GETNAME
#   - Server:       INFO (for health checks)
#
# Denied categories (everything else):
#   - @admin, @dangerous, @slow (CONFIG, DEBUG, SHUTDOWN, FLUSHALL, etc.)
#   - @scripting (EVAL, EVALSHA)
#   - @pubsub (not used; prevents channel injection)
#   - @stream, @sortedset, @list, @hash, @geo, @hyperloglog (unused data types)
#
# Key patterns:
#   sess:*             - session blobs
#   user_sessions:*    - per-user session index sets
#   pkce_state:*       - PKCE code verifier ephemeral keys
#   jwks:*             - cached JWKS key material
#
# Password:
#   Replace the hash below with your production secret hash.
#   The placeholder resolves to the string "CHANGE_ME_IN_PRODUCTION".

user app on \
    #8d26f965f4fd3a680ee4b9c754bab15deaf3c31a3e9dc0b3c7e12b3a0a1f4e6d \
    ~sess:* ~user_sessions:* ~pkce_state:* ~jwks:* \
    +@read +@write +@set +@connection +@fast \
    +info +ping +auth +quit +reset \
    +get +set +del +ttl +pttl +expire +pexpire +exists +type +unlink \
    +sadd +srem +smembers +scard +sismember \
    +scan +keys \
    +client|setname +client|getname \
    -@admin -@dangerous -config -debug -shutdown -flushall -flushdb \
    -@scripting -@pubsub -@stream -@sortedset -@list -@hash -@geo -@hyperloglog


# -----------------------------------------------------------------------------
# 3. ADMIN USER -- full access for maintenance and incident response
# -----------------------------------------------------------------------------
# Use this user ONLY from:
#   - Bastion host / jump box
#   - Runbook-driven incident response (see docs/runbooks/auth-operations.md)
#   - Scheduled maintenance (key migrations, ACL rotation)
#
# NEVER embed admin credentials in application code or container images.
#
# Password:
#   Replace the hash below with a strong, separately managed secret.
#   The placeholder resolves to the string "ADMIN_CHANGE_ME_IN_PRODUCTION".

user admin on \
    #a3c2f8d1e5b7094f6a2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4 \
    ~* &* \
    +@all


# =============================================================================
# OPERATIONAL NOTES
# =============================================================================
#
# Verifying ACL is loaded:
#   redis-cli -u redis://admin:<password>@<host>:6379 ACL LIST
#
# Testing app user restrictions:
#   redis-cli -u redis://app:<password>@<host>:6379
#   > CONFIG GET maxmemory         # should return (error) NOPERM
#   > SET sess:t1:abc "test"       # should return OK
#   > SET unrelated:key "test"     # should return (error) NOPERM
#
# Hot-reloading ACLs (no restart required):
#   redis-cli -u redis://admin:<password>@<host>:6379 ACL LOAD
#
# Saving current ACLs to disk:
#   redis-cli -u redis://admin:<password>@<host>:6379 ACL SAVE
#
# Password rotation procedure:
#   1. Generate new password hash.
#   2. Update secrets manager entry.
#   3. Update this file with the new hash.
#   4. Run ACL LOAD on the Redis instance.
#   5. Restart the athyper runtime pods (they read password from env/secrets).
#   6. Verify connectivity from application health checks.
#
# =============================================================================
